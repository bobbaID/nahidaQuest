<!doctype html> 
<html lang="en" > 
<head> 
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <title>nahidaQuest!</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <style type="text/css">
        html {
            height: 100%;
            cursor: url(./assets/cursor.png), auto;  
            display:flex; 
            flex-direction:column; 
            justify-content:center;
            align-items: center;
            /* min-height:100vh; */
        }

        body {
            width: 1640px;
            height: 850px;
            position: relative;
            font-family: 'gi-font';
        }

        /* Small devices (portrait tablets and large phones, 600px and up) */
        @media only screen and (min-width: 600px) {
            body {scale: 0.40;}
        }

        /* Medium devices (landscape tablets, 768px and up) */
        @media only screen and (min-width: 768px) {
            body {transform: scale(1.2);transform-origin: top;};
        } 

        /* Large devices (laptops/desktops, 992px and up) */
        @media only screen and (min-width: 992px) {
            body {transform: scale(1.2);transform-origin: top;};
        } 

        /* Extra large devices (large laptops and desktops, 1200px and up) */
        @media only screen and (min-width: 1200px) {
        body {scale: 0.75;}
        }

        @media only screen and (min-width: 1600px) {
        body {scale: 0.9;}
        }
    </style>

</head>
<body id="bodyID">
    <audio id="bgm" autoplay>
        <source src="horse.ogg" type="audio/ogg">
    </audio>

    <p id="para">
        <div class="energy-primo-container">
            <div class="pill-value"><span id="energy" style="padding-right:10px">0</span></div>
            <div class="pill-value"><span id="primogem" style="padding-right:10px">0</span></div>
            
        </div>
        <div class="score-container">
            <span id="score">0</span>              <!------------------------ CHANGE TO PARAGRAPH LATER -->
            <span id="dps">0</span>
        </div>
        <div class="flex-container-TAB" id="flex-container-TAB">
        </div>

        <div id="demo-container">
            <span id='demo'></span>
        </div>
    </p>

    <table>
        <table id="table1" class="uiTab" style="position: absolute; left: 10px; top:45px; width: 650px; height: 760px; display:flex">
            <tr></tr>
        </table>
        <div id="table2" class="uiTab flex-container-INVENTORY" style="position: absolute; top:40px;"></div>
        <div id="table3" class="uiTab flex-container-EXPEDITION" style="position: absolute; top:55px; left: 12px; width:950px;">
            <div id="expedDiv"></div>
        </div>
        <div id="table4" class="uiTab wish-counter"></div>
        <table id="table5" class="uiTab flex-container-ACHIEVEMENT">
            <tr></tr>
        </table>
    </table>

    <div id="body-border"></div>

<script type="module">
    import { upgradeDictDefault,Inventory,tooltip,expeditionDict,achievementList } from "./defaultData.js"
    import { abbrNum,randomInteger,sortList,generateHeroPrices, unlockExpedition } from "./functions.js"
    import { drawMainBody,demoFunction,createHeroButtonContainer,createExpedTable } from "./drawUI.js"

    var saveValues = {
        clickCountDef:0,
        clickFactorDef:1,
        dpsDef:0,
        realScoreDef:0,
        freeLevelsDef:0,
        primogemDef:1000,
        energyDef:1000,
        rowCountDef:0,
        itemCountDef:0,
    }

    var clickCount = saveValues["clickCountDef"];
    var clickFactor = saveValues["clickFactorDef"];
    var dps = saveValues["dpsDef"];
    var realScore = saveValues["realScoreDef"];

    var freeLevels = saveValues["freeLevelsDef"];
    var primogem = saveValues["primogemDef"];
    var energy = saveValues["energyDef"];

    var rowCount = saveValues["rowCountDef"];
    var itemCount = saveValues["itemCountDef"];

    const ENERGYCHANCE = 500;
    const upperEnergyRate = 15;
    const lowerEnergyRate = 7;
    var clickDelay = 10;
    
    // RMB TO UPDATE CONSTANTS
    const weaponBuffPercent = [0, 10, 100, 1000, 10000, 100000];
    const artifactBuffPercent = [0, 1.02, 1.05, 1.10, 1.20, 1.35];
    
    const WEAPONMAX = 1009;
    const ARTIFACTMAX = 2104;
    const FOODMAX = 3003;
    const XPMAX = 4004;

    const NONWISHHEROMAX = 49
    const WISHHEROMIN = 100;
    const WISHHEROMAX = 112;
    const WISHCOST = 160;
    const STARTINGWISHFACTOR = 50;

    var wishMultiplier = 0;
    var wishCounter = WISHHEROMAX - WISHHEROMIN;

    var demoContainer = document.getElementById("demo-container");
    var score = document.getElementById("score");
    var energyDisplay = document.getElementById("energy");
    var dpsDisplay = document.getElementById("dps");
    var primogemDisplay = document.getElementById("primogem");

    var table1 = document.getElementById("table1");
    var table2 = document.getElementById("table2");
    var table3 = document.getElementById("table3");
    var table4 = document.getElementById("table4");
    var table5 = document.getElementById("table5");
    var TABS = [table1,table2, table3, table4, table5];

    // MAIN BODY VARIABLES
    var mainBody = document.getElementById("bodyID");
    let table6 = document.createElement("table");
    mainBody.appendChild(table6);
    table6.classList += "table6";
    
    var para1 = document.getElementById("para");
    var expedDiv = document.getElementById("expedDiv");
    drawMainBody();

    // TOOLTIPS FOR EXPEDITION
    var expedContainer = document.getElementById("table3");
    expedDiv.style.display = "none";

    // INITIAL LOADING
    loading();
    var upgradeDict = generateHeroPrices(upgradeDictDefault,NONWISHHEROMAX);
    tabChange(1);
    refresh();

    realScore++;
    addNewRow();
    realScore--;

    createExpedition();
    createExpedTable(expedDiv);
    para1.appendChild(expedDiv);

    drawWish()
    var timer = setInterval(timerEvents,1000000);

    // ALL TIME-EVENTS SYNC TO THIS FUNCTION (TIME REFRESH SET TO 0.5 SECONDS)
    function timerEvents() {
        checkAchievement();
        realScore += 0.5 * dps;
        refresh();
        addNewRow();
    } 

    function loading() {
        var overlay = document.getElementById("body-border");
        overlay.classList += "overlay";
        let loadGif = document.createElement("img")
        loadGif.src = "./assets/loading.gif"
        loadGif.style = "width:1000px;height:563px;"
        overlay.appendChild(loadGif);
        setTimeout(removeLoading, 4800);

        function removeLoading() {
            setTimeout(function() {
                overlay.removeChild(overlay.firstElementChild);
                overlay.classList -= "overlay";
                timer = setInterval(timerEvents,500);
            }, 200);
            
        }
    } 
    
    // TOOLTIPS FOR HEROES/ITEMS
    var tooltipTop = (table6.insertRow(0)).insertCell(0);
    tooltipTop.align = "center;"
    tooltipTop.style = "height:300px;"

    var toolImg = document.createElement("img");
    toolImg.src = "./assets/tooltips/empty.png";
    toolImg.style ="width:250px;height:250px;";
    
    // TOOLTIP UI
    tooltipTop.appendChild(toolImg);
    var tooltipText = (table6.insertRow(1)).insertCell(0);

    function changeTooltip(name) {
        let tooltipContent = tooltip[name].text;
        tooltipText.innerText = tooltipContent;
        toolImg.src = "./assets/tooltips/"+name+".png";
    }

    function clearTooltip() {
        tooltipText.innerText = "";
        toolImg.src = "./assets/tooltips/empty.png";
    }

    // ACHIEVEMENTS
    var achievementTypeRawScore = [10,1e3,1e4,1e6,1e8,1e9,1e11,1e12,1e14,1e15,1e17,1e18,1e20,1e21,1e23,1e24];
    var achievementTypeRawDPS =   [1,10,100,10000,1e5,1e6,1e8,1e9,1e11,1e12,1e14,1e15,1e17,1e18,1e20,1e21];
    var achievementTypeRawCollection = "";
    var achievementTypeRawClicking = "";

    var scoreAchievementScore = 1;
    var scoreAchievementDps = 101;

    function popAchievement(achievement) {
        var oldAchievement = document.getElementById("tempAchievement");
        var achievementID = 10000;
        if (oldAchievement != null) {
            mainBody.removeChild(oldAchievement); 
        }

        if (achievement == "score") {
            var achievementText = achievementList[scoreAchievementScore].Name;
            var achievementDesc = achievementList[scoreAchievementScore].Description;
            achievementList[scoreAchievementScore]["Done"] = true;
            achievementID += scoreAchievementScore;
            scoreAchievementScore++;
            primogem += 20;
        } else if (achievement == "dps") {
            var achievementText = achievementList[scoreAchievementDps].Name;
            var achievementDesc = achievementList[scoreAchievementDps].Description;
            achievementList[scoreAchievementDps]["Done"] = true;
            achievementID += scoreAchievementDps;
            scoreAchievementDps++;
            primogem += 20;
        }

        var achievementPopUp = document.createElement("p");
        let achievementH1 = document.createElement("h2");
        achievementH1.innerText = achievementText;
        achievementH1.classList += "achieveH1"
        let achievementH2 = document.createElement("h3");
        achievementH2.innerText = achievementDesc;
        achievementH2.classList += "achieveH2"

        achievementPopUp.appendChild(achievementH1);
        achievementPopUp.appendChild(achievementH2);
        achievementPopUp.id = "tempAchievement"

        achievementPopUp.onclick = achievementPopUp.remove;
        achievementPopUp.classList += "achieve"
        mainBody.appendChild(achievementPopUp); 
        
        let achievementStored = document.createElement("button");
        let achievementStoredH1 = document.createElement("h2");
        achievementStoredH1.innerText = achievementText;
        achievementStoredH1.classList += "achieveStoredH1"
        let achievementStoredH2 = document.createElement("h3");              // MAKE THE BACKGROUND IMAGE SUMERU TALENT
        achievementStoredH2.innerText = achievementDesc;                     // HAVE THE MIDDLE PART INFINITELY EXTEND
        achievementStoredH2.classList += "achieveStoredH2"

        achievementStored.appendChild(achievementStoredH1);
        achievementStored.appendChild(achievementStoredH2);
        achievementStored.classList += "achieve-stored"
        achievementStored.id = achievementID;
        table5.appendChild(achievementStored); 
        sortList("table5");
    }

    function checkAchievement() {
        if (realScore >= achievementTypeRawScore[0] && achievementTypeRawScore.length != 0) {
            popAchievement("score");
            achievementTypeRawScore.shift();
        } else if (dps >= achievementTypeRawDPS[0] && achievementTypeRawDPS.length != 0) {
            popAchievement("dps");
            achievementTypeRawDPS.shift();
        }
    }

    // TAB UI
    createTabs();
    function createTabs() {
        let tabFlex = document.getElementById("flex-container-TAB");
        for (let i = 0; i < TABS.length; i++){
            let tabButton = document.createElement("button");
            tabButton.classList += "tab-button";
            tabButton.style.background = "url(./assets/tab"+ (i + 1) +".png)";
            tabButton.addEventListener('click', function(){
                tabChange(i + 1);
            })
            tabFlex.appendChild(tabButton);
        }
    }

    // CHANGE TABS
    function tabChange(x) {
        for (let i = 0; i < TABS.length; i++){
            TABS[i].style["z-index"] = -1;
        }
        TABS[x-1].style["z-index"] = 1;

         if (x-1 == 0 || x-1 == 1) {
            table6.style.display = "block";
         } else {
            table6.style.display = "none"; 
         }

         if (x-1 == 2) {
            expedDiv.style.display = "block";
         } else {
            expedDiv.style.display = "none";
         }
    }

    // BIG BUTTON FUNCTIONS
    var demo = document.getElementById("demo");
    demo.addEventListener("click", function() {
        clickCount += 1;
        realScore += 1 * clickFactor;
        energyRoll();
        refresh();
    });
    demoFunction();
    
    // ROLL FOR ENERGY
    function energyRoll() {
        let randInt = Math.floor(Math.random() * 1000);
        console.log(randInt)
        clickDelay--;

        if (clickDelay < 1){
            if (randInt < ENERGYCHANCE){
                energy += randomInteger(lowerEnergyRate, upperEnergyRate);
                clickDelay = 20;
            }
        }
    }
    
    // SPAWN NEW HEROES IN LIST
    function addNewRow() {
        for (let i = 0; i < WISHHEROMAX; i++) {
            if (i < WISHHEROMIN && i > NONWISHHEROMAX) continue;
            if (realScore >= upgradeDict[i]["Level"] && upgradeDict[i].Purchased == -1){
                let newRow = table1.insertRow(-1);
                let newCell = newRow.insertCell(0);

                upgradeDict[i].Row = rowCount;
                upgradeDict[i].Purchased = 0;
                
                if (upgradeDict[i]["Level"] == 0) {
                    var heroText = "Summon " + upgradeDict[i].Name + " for help. (" + abbrNum(upgradeDict[i]["Cost"]) + ")";
                } else if (i == 0) {
                    var heroText = "Level Up Nahida (" + abbrNum(upgradeDict[i]["Cost"]) + ")";
                } else {
                    var heroText = "Call for " + upgradeDict[i].Name + "'s help... (" + abbrNum(upgradeDict[i]["Cost"]) + ")";
                }

                let heroID = "but-" + rowCount;
                let heroButtonContainer = createHeroButtonContainer(heroID,heroText);
                let toolName = upgradeDict[i].Name;
                
                heroButtonContainer.addEventListener("mouseover", function() {changeTooltip(toolName)});
                heroButtonContainer.addEventListener("mouseout", function() {clearTooltip()});
                heroButtonContainer.addEventListener("click", function() {upgrade(heroID)});

                newCell.appendChild(heroButtonContainer);
                rowCount++;
            }
        }
    }
    
    // UPGRADE HEROES
    function upgrade(clicked_id) {
        var butIdArray = clicked_id.split("-")[1];
        for (let i = 0; i < WISHHEROMAX; i++) {
            if (i < WISHHEROMIN && i > NONWISHHEROMAX) continue;
            if (upgradeDict[i].Row == butIdArray) {
                let freePass = false;
                if (freeLevels > 0){
                    freePass = true;
                }

                if (realScore >= upgradeDict[i]["Cost"]) {
                    if (freePass == true) {
                        realScore += upgradeDict[i]["Cost"];
                        freeLevels--;
                    }

                    realScore -= upgradeDict[i]["Cost"];
                    if (i == 0) {
                        clickFactor += upgradeDict[i]["Factor"];
                        var nextPrice =  Math.round(upgradeDict[i]["Cost"] * (1.3));
                        upgradeDict[i]["Cost"] = nextPrice;
                    } else {
                        dps += upgradeDict[i]["Factor"];
                        var nextPrice =  Math.round(upgradeDict[i]["Cost"] * (1.15));
                        upgradeDict[i]["Cost"] = nextPrice;
                    }
      
                    upgradeDict[i].Purchased += 1;
                    refresh(clicked_id, nextPrice, i);
                }
            }
        } 
    }

    // ADD TO INVENTORY 
    function inventoryAdd(idNum) {
        itemCount++;
        var itemUniqueID = idNum + "." + itemCount;
        let buttonInv = document.createElement("button");

        buttonInv.id = itemUniqueID;
        buttonInv.addEventListener('click', function(){
            itemUse(itemUniqueID);
        });

        buttonInv.classList += "inventoryButton";
        buttonInv.style.background = "url(./assets/inventory/" + Inventory[idNum].Name + ".jpg)";
        buttonInv.style["background-repeat"] = "no-repeat";
        buttonInv.style["background-size"] = "128px 144px";
        table2.appendChild(buttonInv);
    }

    // INVENTORY UI
    function itemUse(itemUniqueId) {
        let item = document.getElementById(itemUniqueId);
        let itemID = itemUniqueId.split(".")[0];
        if (itemID >= 1001 && itemID < WEAPONMAX){
            for (let i = 0; i < Object.keys(upgradeDict).length; i++) {
                if (i < WISHHEROMIN && i > NONWISHHEROMAX && i != 1 && Inventory[i] == undefined) continue;
                if (upgradeDict[i].Purchased > 0){
                    if (upgradeDict[i].Type == Inventory[itemID].Type){
                        upgradeDict[i]["Factor"] += weaponBuffPercent[Inventory[itemID].Star];
                        refresh("hero", i);
                    }
                }
            }
        } else if (itemID >= 2001 && itemID < ARTIFACTMAX){
            for (let i = 0; i < Object.keys(upgradeDict).length; i++) {
                if (i < WISHHEROMIN && i > NONWISHHEROMAX && i != 1 && Inventory[i] == undefined) continue;
                if (upgradeDict[i].Purchased > 0){
                    upgradeDict[i]["Factor"] *= artifactBuffPercent[Inventory[itemID].Star];
                    upgradeDict[i]["Factor"] = Math.round(upgradeDict[i]["Factor"]);
                    refresh("hero", i);
                }
            }
        }  else if (itemID >= 4001 && itemID <  XPMAX){
            freeLevels += Inventory[itemID].BuffLvl;
            refresh();
        }
        item.remove();
    }

    // EXPEDITION MECHANICS
    // RMB THERES A CHANCE OF FAILURE, IT IS NOT A BUG IF NOTHING HAPPENS
    const ADVENTURECOSTS = [0, 100, 250, 500, 750, 1000];
    const ADVENTUREFAILURE = [0, 0, 5, 10, 20, 30];

    function adventure(type) {
        if (expeditionDict[type].Locked == '1'){
            alert("ITS LOCKED CANT YOU SEE!!!!!!!")
            return                                //// <------------------------ ADD THE POPUP FOR LOCKED
        } else {                                                     
            if (energy >= ADVENTURECOSTS[type]){
                energy -= ADVENTURECOSTS[type];
                refresh();

                let randInt = randomInteger(0, 99);
                if (randInt < ADVENTUREFAILURE[type]){
                    return;
                } else {
                    if (type == 1){
                    inventoryDraw("artifact", 1, 4);
                    inventoryDraw("weapon", 1, 1);
                    inventoryDraw("xp", 2, 2);
                    inventoryDraw("food", 1, 3);
                    }
                    if (type == 2){
                        inventoryDraw("xp", 2, 2);
                        inventoryDraw("xp", 2, 2);
                        inventoryDraw("food", 2, 3);
                        inventoryDraw("artifact", 2, 4);
                        inventoryDraw("weapon", 1, 2);
                    }
                    if (type == 3){
                        inventoryDraw("xp", 2, 3);
                        inventoryDraw("artifact", 3, 4);
                        inventoryDraw("food", 2, 4);
                        inventoryDraw("weapon", 2, 3);
                    }
                    if (type == 4){
                        inventoryDraw("weapon", 3, 4);
                        inventoryDraw("artifact", 3, 4);
                        inventoryDraw("xp", 3, 4);
                        inventoryDraw("food", 2, 4);
                    }
                    if (type == 5){
                        inventoryDraw("artifact", 4, 5);
                        inventoryDraw("weapon", 4, 5);
                        inventoryDraw("food", 2, 5);
                        inventoryDraw("xp", 4, 4);
                    }
                    sortList("table2");
                }
            }  
        }   
    }

    // DRAWS FOR RANDOM INVENTORY LOOT 
    function inventoryDraw(itemType, min, max){
        var upperInventoryType = {"weapon": WEAPONMAX, "artifact": ARTIFACTMAX, "food": FOODMAX, "xp": XPMAX};
        var lowerInventoryType = {"weapon": 1001, "artifact": 2001, "food": 3001, "xp": 4001};
        let temp = 0;
        while (true){
            temp = randomInteger(lowerInventoryType[itemType], upperInventoryType[itemType])
            if (Inventory[temp] == undefined) {continue}
            if (Inventory[temp].Star >= min && Inventory[temp].Star < (max + 1)) {
                inventoryAdd(temp);
                break;
            } else {
                continue;
            }
        }
    }
    
    // CREATING EXPEDITION UI
    function createExpedition() {
        for (let i = 1; i < 6; i++) {
            let expedButton = document.createElement("button");
            
            if (expeditionDict[i]["Locked"] == 1){
                var backgroundImg = "url(./assets/exped6.png)";
            } else {
                var backgroundImg = "url(./assets/exped" + i + ".png)";
            }

            expedButton.id = "exped-" + i;
            expedButton.addEventListener("click", function() {adventure(i)});
            expedButton.addEventListener("mouseover", function() {expedInfo(this.id)});
            expedButton.addEventListener("mouseout", function() {expedInfo(7)});

            expedButton.style.background = backgroundImg;
            expedButton.style['background-repeat'] = "no-repeat";
            expedButton.style['background-size'] = "93%"
            expedButton.classList += "expedition";
            
            expedContainer.appendChild(expedButton);
        }
    }

    function expedInfo(butId){
        let expedTableTemp = document.getElementById("expedTableID")
        let i = 0;
        if (butId == 7) {
            i = 7;
        } else {
            i = butId.split("-")[1];
        }

        if (expeditionDict[i]["Locked"] == 0 || i == 7) {
            expedTableTemp.rows[0].cells[0].innerText = expeditionDict[i]["Text"];
            expedTableTemp.rows[1].cells[0].innerText = expeditionDict[i]["Lore"];
        } else {
            expedTableTemp.rows[0].cells[0].innerText = expeditionDict[6]["Text"];
            expedTableTemp.rows[1].cells[0].innerText = expeditionDict[6]["Lore"];
        }
    }

    // DRAWS/WISH FOR SPECIAL HEROS
    function drawWish() {
        let wishButton = document.createElement("button");
        wishButton.classList += "wish-button";
        wishButton.innerText = "Write for help"
        wishButton.addEventListener("click",function() {
            let mailImage = document.getElementById("mailImage")
            mailImage.src = "./assets/closed.png"
            wish();
        });
        table4.appendChild(wishButton);

        let mailImage = document.createElement("img");
        mailImage.src = "./assets/open.png";
        mailImage.id = "mailImage"
        mailImage.classList += "wish-mail";
        table4.appendChild(mailImage);
    }

    function wish() {
        if (primogem > WISHCOST) {
            primogem -= WISHCOST;
            
            while (wishCounter) {
                let i = randomInteger(WISHHEROMIN, WISHHEROMAX)
                if (upgradeDict[i].Purchased >= -1) {
                    continue;
                } else {
                    
                    upgradeDict[i].Purchased = -1;
                    upgradeDict[i]["Factor"] = Math.round(dps * (STARTINGWISHFACTOR + wishMultiplier)/30);
                    upgradeDict[i]["Cost"] = Math.round(dps * (20));
                    console.log(upgradeDict[i])

                    wishMultiplier += 5;
                    wishCounter--;
                    refresh();
                    break;
                }
            }
        }
    }

    // REFRESH SCORES & ENERGY
    function refresh() {
        let formatScore = abbrNum(realScore);
        if (realScore == 1) {
            score.innerText = formatScore + " Nut";
        } else {
            score.innerText = formatScore + " Nuts";
        }

        let formatDps = abbrNum(dps);
        dpsDisplay.innerText = formatDps + " per second" ;

        energyDisplay.innerText = energy;
        primogemDisplay.innerText = primogem;
        
        if (arguments[0] != undefined){
            if (arguments[0].includes("but-")){
                if (arguments[2] == 0) {
                    var formatCost = abbrNum(arguments[1]);
                } else {
                    var formatCost = abbrNum(arguments[1]);
                }

                var formatATK = abbrNum(upgradeDict[arguments[2]]["Factor"]);
                var heroText =  upgradeDict[arguments[2]].Name + ": " + formatCost + ", ATK: " + formatATK;
                let upgradedHeroButton = document.getElementById(arguments[0])
                upgradedHeroButton.innerText = heroText;
                upgradedHeroButton.style = "background:url(./assets/nahida.webp);  background-size: 90%; background-position: 25% center; background-repeat: no-repeat;";
            }
        } else if (arguments[0] == "hero"){
            let formatATK = abbrNum(upgradeDict[arguments[1]]["Factor"]);
            let formatCost = abbrNum(arguments[1]);
            var heroText =  upgradeDict[arguments[1]].Name + ": " + formatCost + ", ATK: " + formatATK;
            let id="but-" + arguments[1].rowCount + "";
            document.getElementById(id).innerText = heroText;
        }
    }

</script>
</body>
</html>

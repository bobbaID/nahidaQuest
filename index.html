<!doctype html> 
<html lang="en" > 
<head> 
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=0, initial-scale=1, user-scalable=no">
    <title>nahidaQuest!</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <style type="text/css">
        .prevent-select {
            -webkit-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

    
        /* @media only screen and (min-width: 600px) {
            body {transform: scale(0.38);transform-origin: top;};
        }

        @media only screen and (min-width: 768px) {
            body {transform: scale(0.45);transform-origin: top;};
        } 

        @media only screen and (min-width: 992px) {
            body {transform: scale(0.57);transform-origin: top;};
        } 

        @media only screen and (min-width: 1200px) {
            body {transform: scale(0.7);transform-origin: top;};
        }

        @media only screen and (min-width: 1600px) {
            body {transform: scale(0.95);transform-origin: top;};
        } */

         html {
            height: 100%;
            width:100%;
            background: black;
            display: flex;
            justify-content:center;
            align-items: flex-end;
            cursor: url(./assets/cursor.png), auto;
        }

        button {
            cursor: url(./assets/cursor.png), auto
        }

        body {
            position: relative;
            width: 1670px;
            height: 867px;
            font-family: 'gi-font';
        }

    </style>

</head>
<body id="bodyID" class="prevent-select">
    <p id="para">
        <div class="energy-primo-container">
            <div class="pill-value">
                <img class="icon" src="./assets/energyIcon.png">
                <span id="energy" style="padding-right:10px">0</span>
            </div>

            <div class="pill-value">
                <img class="primogem icon" src="./assets/primogemIcon.png">
                <span id="primogem" style="padding-right:10px">0</span>
            </div>
            
        </div>
        <div class="score-container">
            <span id="score">0</span>      
            <span id="dps">0</span>
        </div>
        <div class="flex-container-TAB" id="flex-container-TAB">
        </div>

        <div id="demo-container">
            <span id='demo'></span>
        </div>
    </p>

    <table>
        <div id="table1" class="uiTab flex-container-HERO"></div>
        <div id="table2" class="uiTab flex-container-INVENTORY" style="position: absolute; top:40px;"></div>
        <div id="table3" class="uiTab flex-container-EXPEDITION" style="position: absolute; top:55px; left: 12px; width:950px;">
            <div id="expedDiv"></div>
        </div>
        <div id="table4" class="uiTab wish-counter"></div>
        <table id="table5" class="uiTab flex-container-ACHIEVEMENT">
            <tr></tr>
        </table>
    </table>

    <div id="body-border"></div>

<script type="module">
    import { upgradeDictDefault,Inventory,tooltip,expeditionDict,achievementList,saveValuesDefault } from "./defaultData.js"
    import { abbrNum,randomInteger,sortList,generateHeroPrices, unlockExpedition,getHighestKey } from "./functions.js"
    import { drawMainBody,demoFunction,createHeroButtonContainer,createExpedTable,createAchievement,storeAchievement } from "./drawUI.js"

    var saveValues;
    const ENERGYCHANCE = 500;
    const upperEnergyRate = 15;
    const lowerEnergyRate = 7;
    var clickDelay = 10;
    
    const WEAPONMAX = 1009;
    const ARTIFACTMAX = 2104;
    const FOODMAX = 3003;
    const XPMAX = 4004;

    const NONWISHHEROMAX = 49
    const WISHHEROMIN = 100;
    
    const WISHCOST = 160;
    const STARTINGWISHFACTOR = 50;
    var wishMultiplier = 0;

    var demoContainer = document.getElementById("demo-container");
    var score = document.getElementById("score");
    var energyDisplay = document.getElementById("energy");
    var dpsDisplay = document.getElementById("dps");
    var primogemDisplay = document.getElementById("primogem");

    var table1 = document.getElementById("table1");
    var table2 = document.getElementById("table2");
    var table3 = document.getElementById("table3");
    var table4 = document.getElementById("table4");
    var table5 = document.getElementById("table5");
    var TABS = [table1,table2, table3, table4, table5];

    // MAIN BODY VARIABLES
    var mainBody = document.getElementById("bodyID");
    let table6 = document.createElement("div");
    mainBody.appendChild(table6);
    table6.classList += "table6";
    
    var para1 = document.getElementById("para");
    var expedDiv = document.getElementById("expedDiv");
    drawMainBody();

    // TOOLTIPS FOR EXPEDITION
    var expedContainer = document.getElementById("table3");
    expedDiv.style.display = "none";

    // INITIAL LOADING
    loadingAnimation();
    var upgradeDict = "";
    loadSaveData();

    var WISHHEROMAX = getHighestKey(upgradeDict) + 1;
    refresh();

    saveValues["realScore"]++;
    addNewRow();
    saveValues["realScore"]--;

    createExpedition();
    createExpedTable(expedDiv);
    para1.appendChild(expedDiv);
    settings();
    
    drawWish();
    tabChange(1);
    var timer = setInterval(timerEvents,1000000);
    

    // ALL TIME-EVENTS SYNC TO THIS FUNCTION (TIME REFRESH SET TO 0.5 SECONDS)
    function timerEvents() {
        checkAchievement();
        saveValues["realScore"] += 0.5 * saveValues["dps"];
        refresh();
        dimHeroButton();
        addNewRow();
    } 

    // ALL LOAD FUNCTIONS
    // LOAD SAVE DATA
    function loadSaveData() {
        // LOAD VALUES DATA
        if (localStorage.getItem("saveValuesSave") == null) {
            saveValues = saveValuesDefault;
        } else {
            let saveValuesTemp = localStorage.getItem("saveValuesSave");
            saveValues = JSON.parse(saveValuesTemp)
        }
        // LOAD HEROES DATA
        if (localStorage.getItem("upgradeDictSave") == null) {
            let upgradeDictTemp = generateHeroPrices(upgradeDictDefault,NONWISHHEROMAX);
            upgradeDict = upgradeDictTemp;
        } else {
            let upgradeDictTemp = localStorage.getItem("upgradeDictSave");
            upgradeDict = JSON.parse(upgradeDictTemp);
            var timer2 = setTimeout(loadRow,1000);
        }
    }
       
    function loadingAnimation() {
        var siteWidth = 1080;
        var scale = screen.width / (siteWidth);
        document.querySelector('meta[name="viewport"]').setAttribute('content', 'width='+siteWidth+', initial-scale='+scale/1.85+', user-scalable=no');

        var overlay = document.getElementById("body-border");
        overlay.classList.add("overlay");
        let loadGif = document.createElement("img");
        loadGif.src = "./assets/loading.gif";
        loadGif.style.cssText = "width:1000px;height:563px;";
        overlay.appendChild(loadGif);
        setTimeout(removeLoading, 800);
    }

    function removeLoading() {
        setTimeout(() => {
            let overlay = document.getElementById("body-border");
            overlay.removeChild(overlay.firstElementChild);
            overlay.classList.remove("overlay");
            timer = setInterval(timerEvents,500);
            tutorial();
        }, 200);
    }

    // SETUP AUDIO API
    var currentSong = 1;
    var nextSong = "";
    function playAudio() {
        var bgmElement = new Audio("./assets/sfx/bgm1.mp3");
        bgmElement.id = "bgm";
        bgmElement.play();
        
        bgmElement.addEventListener('ended', () => {
            currentSong++;
            nextSong = "./assets/sfx/bgm"+currentSong+".mp3";
            bgmElement.src = nextSong;
            bgmElement.load();
            bgmElement.play();
            if (currentSong == 5) {currentSong = 1;}
        }, false);

        return bgmElement;
    }

    // TOOLTIP UI
    var tooltipName = document.createElement("div");
    tooltipName.classList += "tool-tip-name";

    var toolImg = document.createElement("img");
    toolImg.src = "./assets/tooltips/Empty.webp";
    toolImg.style = "width:250px;height:250px;";
    
    var tooltipText = document.createElement("div");
    tooltipText.classList += "tool-tip-text";
    var tooltipLore= document.createElement("div");
    tooltipLore.classList += "tool-tip-lore";

    table6.append(tooltipName,toolImg,tooltipText,tooltipLore);

    function changeTooltip(name, type, ID) {
        tooltipName.innerText = tooltip[name]["name"];
        tooltipLore.innerText = tooltip[name]["lore"];
        toolImg.src = "./assets/tooltips/"+name+".webp";

        if (type == "hero") {
            tooltipText.innerHTML += "Times upgraded: " + upgradeDict[ID]["Purchased"];
            tooltipText.innerHTML += "\n Weapon: " + upgradeDict[ID]["Type"];
            tooltipText.innerHTML += "\n Element: " + upgradeDict[ID]["Ele"];
        }
    }

    function clearTooltip() {
        tooltipName.innerText = "";
        tooltipText.innerText = "";
        tooltipLore.innerText = "";
        toolImg.src = "./assets/tooltips/Empty.webp";
    }

    // TAB UI
    createTabs();
    function createTabs() {
        let tabFlex = document.getElementById("flex-container-TAB");
        for (let i = 0; i < TABS.length; i++){
            let tabButton = document.createElement("button");
            tabButton.classList += "tab-button";
            tabButton.style.background = "url(./assets/tab"+ (i + 1) +".png)";
            tabButton.id = "tab-" + i;
            tabButton.addEventListener('click', () =>{
                tabChange(i + 1);
            })
            tabFlex.appendChild(tabButton);
        }
    }

    // CHANGE TABS
    function tabChange(x) {
        for (let i = 0; i < TABS.length; i++){
            TABS[i].style["z-index"] = -1;
        }
        TABS[x-1].style["z-index"] = 1;

         if (x-1 == 0 || x-1 == 1) {
            table6.style["z-index"] = 1;
         } else {
            table6.style["z-index"] = -1; 
         }

         expedDiv.style.display = (x - 1 === 2) ? 'block' : 'none';

         if (x-1 != 3) {
            let mailImageTemp = document.getElementById("mailImageID")
             mailImageTemp.style.opacity = 1;
         }
    }
    
    // TUTORIAL UPON FIRST LOAD
    function tutorial() {
        var currentSlide = 1;
        var tutorialDark = document.createElement("div");
        tutorialDark.classList.add("tutorial-dark");

        var tutorialImage = document.createElement("img");
        tutorialImage.classList.add("tutorial-img");
        tutorialImage.id = "tutorialImg";
        tutorialImage.src = "./assets/tutorial/tut-1.jpg"
        
        var tutorialScreen = document.createElement("div");
        tutorialScreen.classList.add("tutorial-screen");
        tutorialScreen.addEventListener("click", () => {
            if (currentSlide == 4) {
                tutorialDark.remove();
                var currentBGM = playAudio();
                settingsVolume(currentBGM);
                return;
            }

            currentSlide++;
            let currentTutorialImage = document.getElementById("tutorialImg");
            currentTutorialImage.src = "./assets/tutorial/tut-"+currentSlide+".jpg";
        })

        tutorialScreen.appendChild(tutorialImage);
        tutorialDark.appendChild(tutorialScreen);
        para1.appendChild(tutorialDark);
    }

    // SETTINGS MENU
    var settingsOpen = false;
    function settings() {
        var settingsMenu = document.createElement("div");
        settingsMenu.id = "settings-menu";
        settingsMenu.classList.add("settings-menu");

        var volumeScroller = document.createElement("input");
        volumeScroller.type = "range";
        volumeScroller.min = "0";
        volumeScroller.max = "100";
        volumeScroller.value = "50";
        volumeScroller.id = "volume-scroller";

        var saveSetting = document.createElement("button");
        saveSetting.classList.add("setting-save");
        saveSetting.addEventListener("click",() => {
            localStorage.setItem("saveValuesSave", JSON.stringify(saveValues));
            localStorage.setItem("upgradeDictSave", JSON.stringify(upgradeDict));
        })
        var clearSetting = document.createElement("button");
        clearSetting.classList.add("setting-clear");
        clearSetting.addEventListener("click",() => {localStorage.clear();location.reload()})

        settingsMenu.append(volumeScroller, saveSetting, clearSetting);
        mainBody.appendChild(settingsMenu);

        let settingButton = document.createElement("button");
        settingButton.classList.add("settings-button");
        settingButton.addEventListener("click", () => {
            if (settingsOpen == false) {
                settingsMenu.style.zIndex = 4;
                settingsOpen = true;
            }
            else {
                settingsMenu.style.zIndex = -1;
                settingsOpen = false;
            }
        })
        para1.appendChild(settingButton);
    }

    function settingsVolume(bgmElement) {
        let volumeScroller = document.getElementById('volume-scroller');
        volumeScroller.addEventListener("change", function() {
            bgmElement.volume = this.value / 100;
        });
    }

    // BIG BUTTON FUNCTIONS
    var demo = document.getElementById("demo");
    demo.addEventListener("click", () => {
        saveValues["clickCount"] += 1;
        saveValues["realScore"] += 1 * saveValues["clickFactor"];
        energyRoll();
        refresh();
    });
    demoFunction();
    
    // ROLL FOR ENERGY
    function energyRoll() {
        let randInt = Math.floor(Math.random() * 1000);
        clickDelay--;

        if (clickDelay < 1){
            if (randInt < ENERGYCHANCE){
                saveValues["energy"] += randomInteger(lowerEnergyRate, upperEnergyRate);
                clickDelay = 20;
            }
        }
    }
    
    // LOAD SAVED HEROES IN TABLE1
    var rowTempDict = {};
    function loadRow() {
        for (let i = 0; i < WISHHEROMAX; i++) {
            if (i < WISHHEROMIN && i > NONWISHHEROMAX || upgradeDict[i] == undefined) continue;
            if (upgradeDict[i].Row > -1){
                rowTempDict[[upgradeDict[i].Row]] = i;
            }
        }
        
        for (let j = 0; j < Object.keys(rowTempDict).length; j++) {
            let loadedHeroID = rowTempDict[j]
            var heroTextLoad;
            var heroPurchasedOnceStyle;
            var purchased = false;
            if (upgradeDict[loadedHeroID]["Purchased"] > 0) {
                let formatCost = abbrNum(upgradeDict[loadedHeroID]["Cost"]);
                let formatATK = abbrNum(upgradeDict[loadedHeroID]["Factor"]);
                purchased = true;
                if (j == 0) {
                    let singular = ` Nut${upgradeDict[j]["Factor"] !== 1 ? 's' : ''} per click`;
                    heroTextLoad =  upgradeDict[j].Name + ": " + formatCost + ", " + formatATK + singular;
                } else {
                    heroTextLoad =  upgradeDict[loadedHeroID].Name + ": " + formatCost + ", +" + formatATK + " NpS";
                }
            } else {
                if (upgradeDict[loadedHeroID]["Level"] == 0) {
                    heroTextLoad = "Summon " + upgradeDict[loadedHeroID].Name + " for help. (" + abbrNum(upgradeDict[loadedHeroID]["Cost"]) + ")";
                } else if (j == 0) {
                    heroTextLoad = "Level Up Nahida (" + abbrNum(upgradeDict[j]["Cost"]) + ")";
                } else {
                    heroTextLoad = "Call for " + upgradeDict[loadedHeroID].Name + "'s help... (" + abbrNum(upgradeDict[loadedHeroID]["Cost"]) + ")";
                }
            }

            let heroID = "but-" + j;
            let heroButtonContainer = createHeroButtonContainer(heroID,heroTextLoad);
            let toolName = upgradeDict[loadedHeroID].Name;
            if (purchased == true) {heroButtonContainer.style="background:url(./assets/nameplates/"+upgradeDict[loadedHeroID].Name.replace(/ /g,'')+".webp);  background-size: 125%; background-position: 99% center; background-repeat: no-repeat;"}

            heroButtonContainer.addEventListener("mouseover", () => {changeTooltip(toolName, "hero", rowTempDict[j])});
            heroButtonContainer.addEventListener("mouseout", () => {clearTooltip()});
            heroButtonContainer.addEventListener("click", () => {upgrade(heroID)});
            table1.appendChild(heroButtonContainer);
        }
    }

    // ADD NEW HEROES TO TABLE1
    function addNewRow() {
        for (let i = 0; i < WISHHEROMAX; i++) {
            if (i < WISHHEROMIN && i > NONWISHHEROMAX || upgradeDict[i] == undefined) continue;
            if (upgradeDict[i].Row != -1) continue;
            if (saveValues["realScore"] >= upgradeDict[i]["Level"] && upgradeDict[i].Purchased == -1){
                upgradeDict[i].Row = saveValues["rowCount"];
                upgradeDict[i].Purchased = 0;
                console.log(upgradeDict[i])
                
                if (upgradeDict[i]["Level"] == 0) {
                    var heroText = "Summon " + upgradeDict[i].Name + " for help. (" + abbrNum(upgradeDict[i]["Cost"]) + ")";
                } else if (i == 0) {
                    var heroText = "Level Up Nahida (" + abbrNum(upgradeDict[i]["Cost"]) + ")";
                } else {
                    var heroText = "Call for " + upgradeDict[i].Name + "'s help... (" + abbrNum(upgradeDict[i]["Cost"]) + ")";
                }

                let heroID = "but-" + saveValues["rowCount"];
                let heroButtonContainer = createHeroButtonContainer(heroID,heroText);
                let toolName = upgradeDict[i].Name;
                
                heroButtonContainer.addEventListener("mouseover", () => {changeTooltip(toolName, "hero", i)});
                heroButtonContainer.addEventListener("mouseout", () => {clearTooltip()});
                heroButtonContainer.addEventListener("click", () => {upgrade(heroID)});

                table1.appendChild(heroButtonContainer);
                saveValues["rowCount"]++;
            }
        }
    }
    
    // UPGRADE HEROES
    function upgrade(clicked_id) {
        var butIdArray = clicked_id.split("-")[1];
        for (let i = 0; i < WISHHEROMAX; i++) {
            if (i < WISHHEROMIN && i > NONWISHHEROMAX) continue;
            if (upgradeDict[i].Row == butIdArray) {
                let freePass = false;
                if (saveValues["freeLevels"] > 0){
                    freePass = true;
                }

                if (saveValues["realScore"] >= upgradeDict[i]["Cost"]) {
                    if (freePass == true) {
                        saveValues["realScore"] += upgradeDict[i]["Cost"];
                        saveValues["freeLevels"]--;
                    }

                    saveValues["realScore"] -= upgradeDict[i]["Cost"];
                    if (i == 0) {
                        saveValues["clickFactor"] += upgradeDict[i]["Factor"];
                        var nextPrice =  Math.round(upgradeDict[i]["Cost"] * (1.3));
                        upgradeDict[i]["Cost"] = nextPrice;
                    } else {
                        saveValues["dps"] += upgradeDict[i]["Factor"];
                        var nextPrice =  Math.round(upgradeDict[i]["Cost"] * (1.2));
                        upgradeDict[i]["Cost"] = nextPrice;
                    }
      
                    upgradeDict[i].Purchased += 1;
                    refresh(clicked_id, nextPrice, i);
                    dimHeroButton();
                    clearTooltip();
                    changeTooltip(upgradeDict[i]["Name"],"hero",i);
                }
            }
        } 
    }

    // CHECK IF PRICE IS LOWER THAN CURRENT SCORE
    function dimHeroButton() {
        for (let i = 0; i < WISHHEROMAX; i++) {
            if (i < WISHHEROMIN && i > NONWISHHEROMAX) continue;
            if (upgradeDict[i]["Purchased"] < 0) continue;

            let heroID = "but-" + upgradeDict[i].Row;
            if (upgradeDict[i]["Cost"] > saveValues["realScore"]) {
                document.getElementById(heroID).classList.add("dim");
                document.getElementById(heroID).classList.remove("not-dim");
            } else if (upgradeDict[i]["Cost"] <= saveValues["realScore"]) {
                document.getElementById(heroID).classList.add("not-dim");
                document.getElementById(heroID).classList.remove("dim");
            }
        } 
    }

    // ADD TO INVENTORY 
    function inventoryAdd(idNum) {
        saveValues["itemCount"]++;
        var itemUniqueID = idNum + "." + saveValues["itemCount"];
        let buttonInv = document.createElement("button");

        buttonInv.id = itemUniqueID;
        buttonInv.addEventListener('click', () => {itemUse(itemUniqueID);});
        buttonInv.addEventListener('mouseover', () => {changeTooltip(Inventory[idNum].Name, "item", 1)})
        buttonInv.addEventListener('mouseout', () => {clearTooltip();})

        buttonInv.classList += "inventoryButton";
        buttonInv.style.background = "url(./assets/inventory/" + Inventory[idNum].Name + ".jpg)";
        buttonInv.style["background-repeat"] = "no-repeat";
        buttonInv.style["background-size"] = "118px 144px";
        table2.appendChild(buttonInv);
    }

    // INVENTORY UI
    // RMB TO UPDATE CONSTANTS
    const weaponBuffPercent = [0, 1.1, 1.3, 1.7, 2.3, 3];
    const artifactBuffPercent = [0, 1.02, 1.05, 1.10, 1.20, 1.35];

    function itemUse(itemUniqueId) {
        let item = document.getElementById(itemUniqueId);
        let itemID = itemUniqueId.split(".")[0];
        if (itemID >= 1001 && itemID < WEAPONMAX){
            for (let i = 0; i < WISHHEROMAX; i++) {
                if (i < WISHHEROMIN && i > NONWISHHEROMAX && i != 1 && Inventory[i] == undefined) continue;
                if (upgradeDict[i].Purchased > 0){
                    if (upgradeDict[i].Type == Inventory[itemID].Type){
                        upgradeDict[i]["Factor"] *= weaponBuffPercent[Inventory[itemID].Star];
                        upgradeDict[i]["Factor"] = Math.ceil(upgradeDict[i]["Factor"]);
                        refresh("hero", i);
                    }
                }
            }
        } else if (itemID >= 2001 && itemID < ARTIFACTMAX){
            for (let i = 0; i < Object.keys(upgradeDict).length; i++) {
                if (i < WISHHEROMIN && i > NONWISHHEROMAX && i != 1 && Inventory[i] == undefined) continue;
                if (upgradeDict[i].Purchased > 0){
                    upgradeDict[i]["Factor"] *= artifactBuffPercent[Inventory[itemID].Star];
                    upgradeDict[i]["Factor"] = Math.ceil(upgradeDict[i]["Factor"]);
                    refresh("hero", i);
                }
            }
        }  else if (itemID >= 4001 && itemID <  XPMAX){
            saveValues["freeLevels"] += Inventory[itemID].BuffLvl;
            refresh();
        }
        item.remove();
    }

    // EXPEDITION MECHANICS
    const ADVENTURECOSTS = [0, 100, 250, 500, 750, 1000];

    function adventure(type) {
        if (expeditionDict[type].Locked == '1'){
            alert("ITS LOCKED CANT YOU SEE!!!!!!!")
            return                                //// <------------------------ ADD THE POPUP FOR LOCKED
        } else {                                                     
            if (saveValues["energy"] >= ADVENTURECOSTS[type]){
                saveValues["energy"] -= ADVENTURECOSTS[type];
                refresh();
                
                switch (type) {
                    case 1:
                        inventoryDraw("artifact", 1, 4);
                        inventoryDraw("weapon", 1, 1);
                        inventoryDraw("xp", 2, 2);
                        inventoryDraw("food", 1, 3);
                        break;
                    case 2:
                        inventoryDraw("xp", 2, 2);
                        inventoryDraw("food", 2, 3);
                        inventoryDraw("artifact", 2, 4);
                        inventoryDraw("weapon", 1, 2);
                        break;
                    case 3:
                        inventoryDraw("xp", 2, 3);
                        inventoryDraw("artifact", 3, 4);
                        inventoryDraw("food", 2, 4);
                        inventoryDraw("weapon", 2, 3);
                        break;
                    case 4:
                        inventoryDraw("weapon", 3, 4);
                        inventoryDraw("artifact", 3, 4);
                        inventoryDraw("xp", 3, 4);
                        inventoryDraw("food", 2, 4);
                        break;
                    case 5:
                        inventoryDraw("artifact", 4, 5);
                        inventoryDraw("weapon", 4, 5);
                        inventoryDraw("food", 2, 5);
                        inventoryDraw("xp", 4, 4);
                        break;
                    default:
                        // handle unexpected type
                        break;
                }
                sortList("table2");
                newPop(2);
            }  
        }   
    }

    // DRAWS FOR RANDOM INVENTORY LOOT 
    function inventoryDraw(itemType, min, max){
        var upperInventoryType = {"weapon": WEAPONMAX, "artifact": ARTIFACTMAX, "food": FOODMAX, "xp": XPMAX};
        var lowerInventoryType = {"weapon": 1001, "artifact": 2001, "food": 3001, "xp": 4001};
        let temp = 0;
        while (true){
            temp = randomInteger(lowerInventoryType[itemType], upperInventoryType[itemType])
            if (Inventory[temp] == undefined) {continue}
            if (Inventory[temp].Star >= min && Inventory[temp].Star < (max + 1)) {
                inventoryAdd(temp);
                break;
            } else {
                continue;
            }
        }
    }
    
    // CREATING EXPEDITION UI
    function createExpedition() {
        for (let i = 1; i < 6; i++) {
            let expedButton = document.createElement("button");
            
            if (expeditionDict[i]["Locked"] == 1){
                var backgroundImg = "url(./assets/exped6.png)";
            } else {
                var backgroundImg = "url(./assets/exped" + i + ".png)";
            }

            expedButton.id = "exped-" + i;
            expedButton.addEventListener("click", () => {adventure(i)});
            expedButton.addEventListener("mouseover", function() {expedInfo(this.id)});
            expedButton.addEventListener("mouseout", () => {expedInfo(7)});

            expedButton.style.background = backgroundImg;
            expedButton.style['background-repeat'] = "no-repeat";
            expedButton.style['background-size'] = "93%"
            expedButton.classList += "expedition";
            
            expedContainer.appendChild(expedButton);
        }
    }

    function expedInfo(butId) {
        let expedTableTemp = document.getElementById("expedTableID");
        let i = 0;

        let afterEnergyIcon = document.createElement("img");
        afterEnergyIcon.classList += "after-icon";
        afterEnergyIcon.id = "afterEnergyIcon"
        
        if (butId == 7) {
            i = 7;
        } else {
            i = butId.split("-")[1];
        }

        if (expeditionDict[i]["Locked"] == 0 || i == 7) {
            expedTableTemp.rows[0].cells[0].innerHTML = expeditionDict[i]["Text"];
            expedTableTemp.rows[1].cells[0].innerText = expeditionDict[i]["Lore"];
            expedTableTemp.rows[0].cells[0].appendChild(afterEnergyIcon);
        } else {
            expedTableTemp.rows[0].cells[0].innerHTML = expeditionDict[6]["Text"];
            expedTableTemp.rows[1].cells[0].innerText = expeditionDict[6]["Lore"];
        }

        if (i == 7) {
            let afterEnergyRemove = document.getElementById("afterEnergyIcon");
            afterEnergyRemove.remove();
        }
    }

    // DRAWS/WISH FOR SPECIAL HEROS
    function drawWish() {
        let wishButton = document.createElement("button");
        wishButton.classList += "wish-button";
        wishButton.innerText = "Write for help | 160 "
        wishButton.addEventListener("click",() => {
             wish();
        });

        let mailImageContainer = document.createElement("div");
        mailImageContainer.classList.add("wish-mail-container");
        
        let mailImageBottom = document.createElement("img");
        mailImageBottom.src = "./assets/closed.png";
        mailImageBottom.classList.add("wish-mail");

        let mailImageTop = document.createElement("img");
        mailImageTop.src = "./assets/open.png";
        mailImageTop.id = "mailImageID";
        mailImageTop.classList.add("wish-mail");

        mailImageContainer.append(mailImageBottom,mailImageTop);
        table4.append(mailImageContainer, wishButton);
    }

    var wishCounter = WISHHEROMAX - WISHHEROMIN;
    function wish() {
        if (wishCounter == 0) {
            return;
        }

        if (saveValues["primogem"] > WISHCOST) {
            saveValues["primogem"] -= WISHCOST;

            while (wishCounter) {
                let randomWishHero = randomInteger(WISHHEROMIN, WISHHEROMAX)
                if (upgradeDict[randomWishHero].Purchased >= -1) {
                    continue;
                } else {
                    upgradeDict[randomWishHero].Purchased = -1;
                    upgradeDict[randomWishHero]["Factor"] = Math.round(saveValues["dps"] * (STARTINGWISHFACTOR + wishMultiplier)/50 + 1);
                    upgradeDict[randomWishHero]["Cost"] = Math.round(saveValues["dps"] * (55) + 1);
                    wishMultiplier += 1.5;
                    wishCounter--;
                    refresh();
                    newPop(1);

                    let mailImageTemp = document.getElementById("mailImageID")
                    mailImageTemp.style.opacity = 0;
                    break;
                }
            }
        } else {return;}
    }

    // POP UPS FOR NEW HEROES(WISH), INVENTORY AND EXPEDITION
    var currentPopUps = [];
    function newPop(type) {
    var newPopUp;
    let className;
    let tabId;

    switch (type) {
        case 1:
            className = "pop-new-one";
            tabId = "tab-0";
            break;
        case 2:
            className = "pop-new-two";
            tabId = "tab-1";
            break;
        case 3:
            className = "pop-new-three";
            tabId = "tab-2";
            break;
    }
    
    if (newPopUp || currentPopUps.includes(type) == true) {
        return;
    }

    newPopUp = document.createElement("img");
    newPopUp.classList.add("pop-new", className);
    currentPopUps.push(type);

    let tab = document.getElementById(tabId);
    tab.addEventListener("click", () => {
        newPopUp.remove();
        currentPopUps.splice(currentPopUps.indexOf(type),1)
        newPopUp = null;
    });

    para1.appendChild(newPopUp);
}
    
    // ACHIEVEMENTS
    var achievementData = {
        achievementTypeRawScore: [10,1e3,1e4,1e6,1e8,1e9,1e11,1e12,1e14,1e15,1e17,1e18,1e20,1e21,1e23,1e24],
        achievementTypeRawDPS:   [1,10,100,10000,1e5,1e6,1e8,1e9,1e11,1e12,1e14,1e15,1e17,1e18,1e20,1e21],
        achievementTypeRawClick: [1e2,1e3,1e4,1e5,1e6],
        achievementTypeRawCollection: [1e1,1e2,1e3,1e4,1e5],
    };

    var scoreAchievement = [1,101,201,301];

    function popAchievement(achievement) {
        var timerAchievement = "";
        var oldAchievement = document.getElementById("tempAchievement");
        var achievementID = 10000;
        let achievementType = "";

        if (oldAchievement != null) {
            mainBody.removeChild(oldAchievement); 
        }

        if (achievement == "score") {
            achievementType = scoreAchievement[0];
            scoreAchievement[0]++;
        } else if (achievement == "dps") {
            achievementType = scoreAchievement[1];
            scoreAchievement[1]++;
        } 

        var achievementText = achievementList[achievementType].Name;
        var achievementDesc = achievementList[achievementType].Description;
        achievementList[achievementType]["Done"] = true;
        achievementID += achievementType;
        saveValues["primogem"] += 20;

        var achievementPopUp = createAchievement(achievementText,achievementDesc);
        achievementPopUp.addEventListener("click", () => {achievementPopUp.remove()});
        mainBody.appendChild(achievementPopUp);
        timerAchievement = setInterval(() => achievementPopUp.remove(),5000)

        //  ^^^ TEMP ACHIEVEMENT | PERMANENT ACHIEVEMENT vvv
        
        let achievementStored = storeAchievement(achievementText,achievementDesc,achievementID);
        table5.appendChild(achievementStored); 
        sortList("table5");
    }

    function checkAchievement() {
        if (achievementData["achievementTypeRawScore"].length !== 0){
            if (saveValues["realScore"] >= achievementData["achievementTypeRawScore"][0]) {
                popAchievement("score");
                achievementData["achievementTypeRawScore"].shift();
            }
        } 
        
        if (achievementData["achievementTypeRawDPS"].length !== 0){
            if (saveValues["dps"] >= achievementData["achievementTypeRawDPS"][0]) {
                popAchievement("dps");
                achievementData["achievementTypeRawDPS"].shift();
            }
        }
    }

    // REFRESH SCORES & ENERGY
    function refresh() {
        let formatScore = abbrNum(saveValues["realScore"]);
        score.innerText = `${formatScore} Nut${saveValues["realScore"] !== 1 ? 's' : ''}`;

        let formatDps = abbrNum(saveValues["dps"]);
        dpsDisplay.innerText = formatDps + " per second" ;
        energyDisplay.innerText = saveValues["energy"];
        primogemDisplay.innerText = saveValues["primogem"];
        
        if (arguments[0] != undefined) {
            if (arguments[0].includes("but-")){
                var heroTextFirst = "";
                let formatCost = abbrNum(arguments[1]);
                let formatATK = abbrNum(upgradeDict[arguments[2]]["Factor"]);

                if (arguments[2] == 0) {
                    let singular = ` Nut${upgradeDict[arguments[2]]["Factor"] !== 1 ? 's' : ''} per click`;
                    heroTextFirst =  upgradeDict[arguments[2]].Name + ": " + formatCost + ", " + formatATK + singular;
                } else {
                    heroTextFirst =  upgradeDict[arguments[2]].Name + ": " + formatCost + ", +" + formatATK + " NpS";
                }
                
                let upgradedHeroButton = document.getElementById(arguments[0]);
                upgradedHeroButton.innerText = heroTextFirst;
                upgradedHeroButton.style = "background:url(./assets/nameplates/"+upgradeDict[arguments[2]].Name.replace(/ /g,'')+".webp);  background-size: 125%; background-position: 99% center; background-repeat: no-repeat;";
            }
        } else if (arguments[0] == "hero") {
            let formatATK = abbrNum(upgradeDict[arguments[1]]["Factor"]);
            let formatCost = abbrNum(arguments[1]);
            var heroText =  upgradeDict[arguments[1]].Name + ": " + formatCost + ", " + formatATK + " NpS";
            let id="but-" + arguments[1].rowCount + "";
            document.getElementById(id).innerText = heroText;
        }
    }

</script>
</body>
</html>

<!doctype html> 
<html lang="en" > 
<head> 
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, height=device-height, initial-scale=1, user-scalable=no">
    <meta name="google-site-verification" content="0t3askxEnPVFJR9Weog42wM1qUF5l0nH63GhSrtzCfg" />
    <meta name="description" content="Help Nahida on her quest to obtain riches!"/>
    <title>nahidaQuest!</title>
    <script src="//cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <style type="text/css">
    </style>

</head>
<body>
    <div id="game" class="prevent-select">
        <div id="loading" class="overlay">
            <img src="./assets/loading.gif" class="overlay-tutorial">
        </div>
        <div id="left-div" class="left-area">
            <div class="score-container">
                <span id="score">0</span>      
                <span id="dps">0</span>
            </div>

            <div id="demo-container">
                <!-- <span id='demo'></span> -->
            </div>
        </div>

        <div id="mid-div" class="middle-area">
            <img src="./assets/bar.jpg" class="middle-bar">
            <div class="energy-primo-container">
                <div class="pill-value">
                    <img class="pill" src="./assets/pill.png">
                    <img class="icon" src="./assets/icon/energyIcon.png">
                    <span id="energy">0</span>
                </div>
                <div class="pill-value">
                    <img class="pill" src="./assets/pill.png">
                    <img class="primogem icon" src="./assets/icon/primogemIcon.png">
                    <span id="primogem">0</span>
                </div>
            </div>
            <div class="temp-buff">
                <div id="app1"></div>
                <div id="app2"></div>
            </div>
        </div>

        <div id="right-div" class="right-area"></div>
    </div>
        
<script type="module">
    import { upgradeDictDefault,SettingsDefault,InventoryDefault,tooltip,expeditionDictDefault,achievementListDefault,saveValuesDefault } from "./defaultData.js"
    import { abbrNum,randomInteger,sortList,generateHeroPrices,unlockExpedition,getHighestKey,countdownText } from "./functions.js"
    import { drawMainBody,demoFunction,createHeroButtonContainer,createExpedTable,createAchievement,storeAchievement,drawMailTable } from "./drawUI.js"
    import { inventoryAddButton,expedButtonAdjust,dimMultiplierButton,volumeScrollerAdjust,floatText,multiplierButtonAdjust } from "./adjustUI.js"

    var saveValues;
    const ENERGYCHANCE = 500;
    const upperEnergyRate = 15;
    const lowerEnergyRate = 7;
    const COSTRATIO = 1.15;
    var clickDelay = 10;
    
    const WEAPONMAX = 1161;
    const ARTIFACTMAX = 2104;
    const FOODMAX = 3003;
    const XPMAX = 4004;

    const NONWISHHEROMAX = 49
    const WISHHEROMIN = 100;
    // NAHIDA'S BASE COST   v
    // var heroCurrentCosts = new Map();
    // heroCurrentCosts.set(0,20);
    
    const WISHCOST = 160;
    const STARTINGWISHFACTOR = 50;
    var wishMultiplier = 0;

    var foodBuff = 1;
    var timeSnapshot1 = 0;
    var timeSnapshot2 = 0;
    var timerAchievement = "";

    var demoContainer = document.getElementById("demo-container");
    var score = document.getElementById("score");
    var energyDisplay = document.getElementById("energy");
    var dpsDisplay = document.getElementById("dps");
    var primogemDisplay = document.getElementById("primogem");

    var leftDiv = document.getElementById("left-div");
    var midDiv = document.getElementById("mid-div");
    var multiplierButtonContainer;
    //------------------------------------------------------------------------INITIAL SETUP------------------------------------------------------------------------//
    // MAIN BODY VARIABLES
    var mainBody = document.getElementById("game");    
    var para1 = document.getElementById("para");
    drawMainBody();

    var table1 = document.getElementById("table1");
    var table2 = document.getElementById("table2");
    var table3 = document.getElementById("table3");
    var expedTooltip = document.getElementById("expedTooltip");
    var expedDiv = document.getElementById("expedDiv");
    var table4 = document.getElementById("table4");
    var table5 = document.getElementById("table5");
    var table5Container = document.getElementById("table5-container");
    var table6 = document.getElementById("table6");
    var TABS = [table1,table2, table3, table4, table5Container];

    // TOOLTIPS FOR EXPEDITION
    var expedContainer = document.getElementById("table3");

    // INITIAL LOADING
    loadSaveData();
    loadingAnimation();
    var upgradeDict;
    var expeditionDict;
    var Inventory;
    var achievementList;

    var WISHHEROMAX = getHighestKey(upgradeDict) + 1;
    var wishCounter = WISHHEROMAX - WISHHEROMIN;
    refresh();

    saveValues["realScore"]++;
    addNewRow();
    saveValues["realScore"]--;

    createMultiplierButton();
    createExpedition();
    createExpedTable(expedTooltip);
    table3.appendChild(expedTooltip);
    settings();           
    
    drawWish();
    var settingsValues;
    var currentBGM;
    var bgmElement;
    var tabElement = new Audio("./assets/sfx/tab-change.mp3");
    var demoElement = new Audio("./assets/sfx/click.mp3");
    var upgradeElement = new Audio("./assets/sfx/upgrade.mp3");
    var mailElement = new Audio("./assets/sfx/mail.mp3");
    var achievementElement = new Audio("./assets/sfx/achievement.mp3");
    var sfxArray = [tabElement,demoElement,upgradeElement];

    var timerLoad = setInterval(timerEventsLoading,50);
    var timer = setInterval(timerEvents,1000000);
    const timeRatio = 500;
    var timerSeconds = 0;
    tabChange(1);
    
    
    // ALL TIME-EVENTS SYNC TO THIS FUNCTION (TIME REFRESH FREQUENCY SET TO TIME RATIO)
    function timerEvents() {
        // 1 timerSeconds == 1 SECOND IN REAL TIME
        let timeRatioTemp =  timeRatio / 1000;
        timerSeconds += timeRatioTemp;
        
        checkAchievement();
        saveValues["realScore"] += timeRatioTemp * saveValues["dps"] * foodBuff;
        refresh();
        dimHeroButton();
        addNewRow();
        foodCheck(timerSeconds);
        

        // SAVES EVERY 3 MINUTES
        if (timerSeconds > 180) {
            saveData();
            console.log("Saved!");
            timerSeconds = 0;
        }
    } 

    // TEMPORARY TIMER
    function timerEventsLoading() {
        addNewRow();
        refresh();
        checkAchievement();
    }

    // LOAD SAVE DATA
    function loadSaveData() {
        // LOAD SETTIGNS
        if (localStorage.getItem("settingsValues") == null) {
            settingsValues = SettingsDefault;
        } else {
            let settingsTemp = localStorage.getItem("settingsValues");
            settingsValues = JSON.parse(settingsTemp)
        }
        // LOAD VALUES DATA
        if (localStorage.getItem("saveValuesSave") == null) {
            saveValues = saveValuesDefault;
        } else {
            let saveValuesTemp = localStorage.getItem("saveValuesSave");
            saveValues = JSON.parse(saveValuesTemp)
        }
        // LOAD HEROES DATA
        if (localStorage.getItem("upgradeDictSave") == null) {
            let upgradeDictTemp = generateHeroPrices(upgradeDictDefault,NONWISHHEROMAX);
            upgradeDict = upgradeDictTemp;
        } else {
            let upgradeDictTemp = localStorage.getItem("upgradeDictSave");
            upgradeDict = JSON.parse(upgradeDictTemp);
            var timer2 = setTimeout(loadRow,1000);
        }
        // LOAD INVENTORY DATA
        if (localStorage.getItem("InventorySave") == null) {
            Inventory = InventoryDefault;
        } else {
            let InventoryTemp = localStorage.getItem("InventorySave");
            Inventory = JSON.parse(InventoryTemp);
            inventoryload();
        }
        // LOAD EXPEDITION DATA
        if (localStorage.getItem("expeditionDictSave") == null) {
            expeditionDict = expeditionDictDefault;
        } else {
            let expeditionDictTemp = localStorage.getItem("expeditionDictSave");
            expeditionDict = JSON.parse(expeditionDictTemp)
        }
        // LOAD ACHIEVEMENT DATA
        if (localStorage.getItem("achievementListSave") == null) {
            achievementList = achievementListDefault;
        } else {
            let achievementListTemp = localStorage.getItem("achievementListSave");
            achievementList = JSON.parse(achievementListTemp);
            achievementListload();
        }
    }

    // BIG BUTTON FUNCTIONS
    var clickAudioDelay = null;
    let demoImg = document.createElement("img");
    demoImg.src = "./assets/nahida.png";
    demoImg.classList.add("demo-img");

    demoContainer.addEventListener("click", () => {
        saveValues["clickCount"] += 1;
        saveValues["realScore"] += 1 * saveValues["clickFactor"];
        energyRoll();
        refresh();

        if (clickAudioDelay === null) {
            if (timerSeconds !== 0) {
                let randomInt = (randomInteger(9,15) / 10);
                demoElement.load();
                demoElement.playbackRate = randomInt;
                clickAudioDelay = setTimeout(function() {clickAudioDelay = null}, 75);
                demoElement.play();
            }
        }

        demoContainer = floatText(demoContainer,abbrNum(saveValues["clickFactor"]),randomInteger(20,80),randomInteger(70,100));
        let number = randomInteger(2,6);
        let animation = `fall ${number}s cubic-bezier(1,.05,.55,1.04)`

        var img = document.createElement("img");
        img.src = "./assets/icon/primogemIcon.png";
        img.style.left = `${randomInteger(0,100)}%`
        img.style.animation = animation;
        img.addEventListener('animationend', () => {img.remove();});
        img.classList.add("falling-image");
        leftDiv.appendChild(img);
    });
    demoFunction(demoContainer,demoImg);
    demoContainer.appendChild(demoImg);
    
    // ROLL FOR ENERGY
    function energyRoll() {
        let randInt = Math.floor(Math.random() * 1000);
        clickDelay--;

        if (clickDelay < 1){
            if (randInt < ENERGYCHANCE){
                saveValues["energy"] += randomInteger(lowerEnergyRate, upperEnergyRate);
                clickDelay = 20;
            }
        }
    }
    
    //--------------------------------------------------------------------------MAIN BODY----------------------------------------------------------------------//
    function loadingAnimation() {
        var siteWidth = 1080;
        var scale = screen.width / (siteWidth);
        document.querySelector('meta[name="viewport"]').setAttribute('content', 'width='+siteWidth+', initial-scale='+scale/1.85+', user-scalable=no');
        setTimeout(() => {removeLoading()}, 1200);
    }

    function removeLoading() {
        dimHeroButton();
        setTimeout(() => {
            let overlay = document.getElementById("loading");
            overlay.removeChild(overlay.firstElementChild);
            overlay.classList.remove("overlay");
            tutorial();
        }, 200);
        
    }

    // SETUP AUDIO API
    var currentSong = randomInteger(1,6);
    var nextSong = "";
    function playAudio() {
        bgmElement = new Audio("./assets/sfx/bgm"+currentSong+".mp3");
        bgmElement.id = "bgm";
        bgmElement.volume = settingsValues.bgmVolume;
        bgmElement.play();
        bgmElement.addEventListener('ended', () => {
            if (currentSong === 5) {
                currentSong = 1;
            } else {
                currentSong++;
            }
            nextSong = "./assets/sfx/bgm"+currentSong+".mp3";
            bgmElement.src = nextSong;
            bgmElement.load();
            bgmElement.play();
        }, false); 

        for (let i=0,len=sfxArray.length; i < len; i++) {
            sfxArray[i].volume = settingsValues.sfxVolume;
        }

        return bgmElement;
    }
    
    // TUTORIAL UPON FIRST LOAD
    function tutorial() {
        let overlay = document.getElementById("loading");
        var currentSlide = 1;
        var tutorialDark = document.createElement("div");
        tutorialDark.classList.add("tutorial-dark");

        // let tutorialTopText = document.createElement("img");
        // tutorialTopText.classList.add("tutorial-text");
        // tutorialTopText.src = "./assets/tutorial/tutorialText.webp"

        var tutorialImage = document.createElement("img");
        tutorialImage.classList.add("tutorial-img");
        tutorialImage.id = "tutorialImg";
        tutorialImage.src = "./assets/tutorial/tut-1.jpg"
        
        var tutorialScreen = document.createElement("div");
        tutorialScreen.classList.add("tutorial-screen");
        tutorialScreen.addEventListener("click", () => {
            if (currentSlide == 4) {
                overlay.style.zIndex = -1;
                clearInterval(timerLoad);
                timer = setInterval(timerEvents,timeRatio);
                currentBGM = playAudio();
                settingsVolume();
                return;
            }

            currentSlide++;
            let currentTutorialImage = document.getElementById("tutorialImg");
            currentTutorialImage.src = "./assets/tutorial/tut-"+currentSlide+".jpg";
        })

        tutorialScreen.append(tutorialImage);
        tutorialDark.appendChild(tutorialScreen);
        overlay.appendChild(tutorialDark);
    }

    function saveData() {
        let settingsSaved = {
            bgmVolume:bgmElement.volume,
            sfxVolume:tabElement.volume,
        }
        localStorage.setItem("settingsValues", JSON.stringify(settingsSaved));
        localStorage.setItem("saveValuesSave", JSON.stringify(saveValues));
        localStorage.setItem("upgradeDictSave", JSON.stringify(upgradeDict));
        localStorage.setItem("expeditionDictSave", JSON.stringify(expeditionDict));
        localStorage.setItem("InventorySave", JSON.stringify(Inventory));
        localStorage.setItem("achievementListSave", JSON.stringify(achievementList));
    }

    //------------------------------------------------------------------------ON-BAR BUTTONS------------------------------------------------------------------------//
    // TAB UI
    createTabs();
    function createTabs() {
        let tabFlex = document.getElementById("flex-container-TAB");
        for (let i=0, len=TABS.length; i < len; i++){
            let tabButton = document.createElement("div");
            tabButton.classList += "tab-button-div";
            let tabButtonImage = document.createElement("img");

            tabButtonImage.src = "./assets/icon/tab"+ (i + 1) +".png";
            tabButtonImage.classList += "tab-button";
            tabButton.id = "tab-" + (i);
            tabButton.addEventListener('click', () =>{
                tabChange(i + 1);
            })
            tabButton.appendChild(tabButtonImage);
            tabFlex.appendChild(tabButton);
        }
    }

    // CHANGE TABS
    function tabChange(x) {
        if (timerSeconds !== 0) {
            tabElement.load();
            tabElement.play();
        }
        
        for (let i=0, len=TABS.length; i < len; i++){
            TABS[i].style.display = "none";
        }

        x--;
        TABS[x].style.display = "flex";

         if (x == 0 || x == 1) {
            table6.style.display = "flex";
         } else {
            table6.style.display = "none";
         }

         if (x != 3 && wishCounter != saveValues["wishCounterSaved"]) {
            let mailImageTemp = document.getElementById("mailImageID")
             mailImageTemp.style.opacity = 1;
         }
    }
    
    // SETTINGS MENU - SAVES & VOLUME CONTROL
    var settingsOpen = false;
    function settings() {
        // JUST THE BUTTON FOR SETTING MENU
        let settingButton = document.createElement("button");
        settingButton.classList.add("settings-button");
        let settingButtonImg = document.createElement("img");
        settingButtonImg.src = "./assets/settings.webp";
        settingButtonImg.classList.add("settings-button-img")
        settingButton.appendChild(settingButtonImg);
        settingButton.addEventListener("click", () => {
            if (settingsOpen == false) {
                settingsMenu.style.zIndex = 200;
                settingsOpen = true;
            } else {
                settingsMenu.style.zIndex = -1;
                settingsOpen = false;
            }
        })
        multiplierButtonContainer.prepend(settingButton);

        // RELATED TO SETTINGS MENU
        var settingsMenu = document.createElement("div");
        settingsMenu.id = "settings-menu";
        settingsMenu.classList.add("settings-menu");

        // let settingsMenuBackground = document.createElement("img");
        // settingsMenuBackground.classList.add("settings-menu-background");
        // settingsMenuBackground.src = "./assets/achievementBG.webp"

        let settingsText = document.createElement("img");
        settingsText.classList.add("settings-text");
        settingsText.src = "./assets/settings/Settings.webp"
        
        let volumeScrollerContainer = document.createElement("div")
        volumeScrollerContainer.classList.add("volume-scroller-container");

        let volumeScrollerBGMContainer = document.createElement("div");
        volumeScrollerBGMContainer.classList.add("volume-scroller-container-children");
        let volumeScrollerBGM = document.createElement("input");
        volumeScrollerBGM = volumeScrollerAdjust(volumeScrollerBGM);
        volumeScrollerBGM.id = "volume-scroller-bgm";
        volumeScrollerBGM.value = settingsValues.bgmVolume * 100;

        let volumeScrollerBGMText = document.createElement("div");
        let volumeScrollerBGMTextImage = document.createElement("img");
        volumeScrollerBGMTextImage.src = "./assets/settings/BGM.webp"
        volumeScrollerBGMText.appendChild(volumeScrollerBGMTextImage)
        volumeScrollerBGMContainer.append(volumeScrollerBGMText,volumeScrollerBGM);
        

        let volumeScrollerSFXContainer = document.createElement("div");
        volumeScrollerSFXContainer.classList.add("volume-scroller-container-children");
        let volumeScrollerSFX = document.createElement("input");
        volumeScrollerSFX = volumeScrollerAdjust(volumeScrollerSFX);
        volumeScrollerSFX.id = "volume-scroller-sfx";
        volumeScrollerSFX.value = settingsValues.sfxVolume * 100;

        let volumeScrollerSFXText = document.createElement("div");
        let volumeScrollerSFXTextImage = document.createElement("img");
        volumeScrollerSFXTextImage.src = "./assets/settings/SFX.webp"
        volumeScrollerSFXText.appendChild(volumeScrollerSFXTextImage)
        volumeScrollerSFXContainer.append(volumeScrollerSFXText,volumeScrollerSFX);

        volumeScrollerContainer.append(volumeScrollerBGMContainer,volumeScrollerSFXContainer)

        

        let settingsBottom = document.createElement("div");
        settingsBottom.classList.add("settings-bottom");
        let settingsBottomLeft = document.createElement("div");
        settingsBottomLeft.classList.add("settings-bottom-left");
        let settingsBottomRight = document.createElement("div");
        settingsBottomRight.classList.add("settings-bottom-right");

        settingsBottom.append(settingsBottomLeft,settingsBottomRight);

        var infoSetting = document.createElement("button");
        infoSetting.classList.add("setting-info");
        // infoSetting.addEventListener("click",() => {saveData();})

        var saveSetting = document.createElement("button");
        saveSetting.classList.add("setting-save");
        saveSetting.addEventListener("click",() => {saveData();})

        var clearSetting = document.createElement("button");
        clearSetting.classList.add("setting-clear");
        clearSetting.addEventListener("click",() => {localStorage.clear();location.reload()})

        settingsBottomRight.append(infoSetting,saveSetting,clearSetting)

        settingsMenu.append(settingsText, volumeScrollerContainer, settingsBottom);
        mainBody.appendChild(settingsMenu);
    }

    function settingsVolume() {
        let volumeScroller = document.getElementById('volume-scroller-bgm');
        let bgmAudio = document.getElementById('bgm');
        volumeScroller.addEventListener("change", function() {
            bgmElement.volume = this.value / 100;
        });

        let sfxScroller = document.getElementById('volume-scroller-sfx');
        sfxScroller.addEventListener("change", function() {
            for (let i=0,len=sfxArray.length; i < len; i++) {
                sfxArray[i].volume = this.value / 100;
            }
        });
    }
    
    function createMultiplierButton() {
        multiplierButtonContainer = document.createElement("div");
        multiplierButtonContainer.classList.add("multiplier-button-container");

        let multiplierButton1 = document.createElement("button");
        multiplierButton1 = multiplierButtonAdjust(multiplierButton1,1)
        multiplierButton1.addEventListener("click",() => {costMultiplier(10),currentDimMultiplier = dimMultiplierButton(1, currentDimMultiplier)})

        let multiplierButton2 = document.createElement("button");
        multiplierButton2 = multiplierButtonAdjust(multiplierButton2,2)
        multiplierButton2.addEventListener("click",() => {costMultiplier(25),currentDimMultiplier = dimMultiplierButton(2, currentDimMultiplier)})
        
        let multiplierButton3 = document.createElement("button");
        multiplierButton3 = multiplierButtonAdjust(multiplierButton3,3)
        multiplierButton3.addEventListener("click",() => {costMultiplier(100),currentDimMultiplier = dimMultiplierButton(3, currentDimMultiplier)})

        multiplierButtonContainer.append(multiplierButton3, multiplierButton2, multiplierButton1);
        midDiv.appendChild(multiplierButtonContainer)
    }
    
    
    //------------------------------------------------------------------------TABLE 1 (HEROES)------------------------------------------------------------------------//
    // LOAD SAVED HEROES IN TABLE1
    var rowTempDict = {};
    function loadRow() {
        let i = WISHHEROMAX;
        while (i--) {
            if (upgradeDict[i] == undefined) continue;
            if (i < WISHHEROMIN && i > NONWISHHEROMAX) continue;
            if (upgradeDict[i].Row > -1){
                rowTempDict[[upgradeDict[i].Row]] = i;
            }
        }

        for (let j = 0, len=Object.keys(rowTempDict).length; j < len; j++) {
            let loadedHeroID = rowTempDict[j];
            var heroTextLoad;
            var heroPurchasedOnceStyle;
            var purchased = false;

            let upgradeDictTemp = upgradeDict[loadedHeroID];
            let formatCost = upgradeDictTemp["BaseCost"];
            // heroCurrentCosts.set(j,formatCost)
            let formatATK = upgradeDictTemp["Factor"];

            if (upgradeDictTemp["Purchased"] > 0) {
                formatCost *= (COSTRATIO**upgradeDictTemp["Purchased"])
                // heroCurrentCosts.set(j,formatCost)
                formatCost = abbrNum(formatCost)
                formatATK = abbrNum(formatATK)
                purchased = true;
                if (j == 0) {
                    let singular = ` Nut${upgradeDict[j]["Factor"] !== 1 ? 's' : ''} per click`;
                    heroTextLoad =  upgradeDict[j].Name + ": " + formatCost + ", " + formatATK + singular;
                } else {
                    heroTextLoad =  upgradeDictTemp.Name + ": " + formatCost + ", +" + formatATK + " NpS";
                }
            } else {
                if (upgradeDictTemp["Level"] == 0) {
                    heroTextLoad = "Summon " + upgradeDictTemp.Name + " for help. (" + abbrNum(formatCost) + ")";
                } else if (j == 0) {
                    heroTextLoad = "Level Up Nahida (" + abbrNum(formatCost) + ")";
                } else {
                    heroTextLoad = "Call for " + upgradeDictTemp.Name + "'s help... (" + abbrNum(formatCost) + ")";
                }
            }

            let heroID = "but-" + j;
            let heroButtonContainer = createHeroButtonContainer(heroID);
            let toolName = upgradeDictTemp.Name;
            
            heroButtonContainer.addEventListener("mouseover", () => {changeTooltip(toolName, "hero", rowTempDict[j]);});
            heroButtonContainer.addEventListener("mouseout", () => {clearTooltip()});
            heroButtonContainer.addEventListener("click", () => {
                upgrade(loadedHeroID);
                if (timerSeconds !== 0) {
                    upgradeElement.load();
                    upgradeElement.play();
                }
            });
            heroButtonContainer.innerText = heroTextLoad;

            if (purchased == true) {
                heroButtonContainer.style = "background:url(./assets/nameplates/"+upgradeDictTemp.Name.replace(/ /g,'')+".webp);  background-size: 125%; background-position: 99% center; background-repeat: no-repeat;";
            } else {
                heroButtonContainer.classList += " not-purchased";
            }

            table1.appendChild(heroButtonContainer);
        }
    }

    // ADD NEW HEROES TO TABLE1
    function addNewRow() {
        for (let i = 0, len=WISHHEROMAX; i < len; i++) {
            if (i < WISHHEROMIN && i > NONWISHHEROMAX || upgradeDict[i] == undefined) continue;
            if (upgradeDict[i].Row != -1) continue;
            if (saveValues["realScore"] >= upgradeDict[i]["Level"] && upgradeDict[i].Purchased == -1){
                upgradeDict[i].Row = saveValues["rowCount"];
                upgradeDict[i].Purchased = 0;
                
                if (upgradeDict[i]["Level"] === 0) {
                    var heroText = "Summon " + upgradeDict[i].Name + " for help. (" + abbrNum(upgradeDict[i]["BaseCost"]) + ")";
                } else if (i === 0) {
                    var heroText = "Level Up Nahida (" + abbrNum(upgradeDict[i]["BaseCost"]) + ")";
                } else {
                    var heroText = "Call for " + upgradeDict[i].Name + "'s help... (" + abbrNum(upgradeDict[i]["BaseCost"]) + ")";
                }

                // heroCurrentCosts.set(saveValues["rowCount"],upgradeDict[i]["BaseCost"])
                let heroID = "but-" + saveValues["rowCount"];
                let heroButtonContainer = createHeroButtonContainer(heroID);
                let toolName = upgradeDict[i].Name;
                
                heroButtonContainer.addEventListener("mouseover", () => {changeTooltip(toolName, "hero", i)});
                heroButtonContainer.addEventListener("mouseout", () => {clearTooltip()});
                heroButtonContainer.addEventListener("click", () => {
                    upgrade(i);
                    if (timerSeconds !== 0) {
                        upgradeElement.load();
                        upgradeElement.play();
                    }
                });
                heroButtonContainer.innerText = heroText;
                table1.appendChild(heroButtonContainer);

                saveValues["rowCount"]++;
            }
        }
    }
    
    // UPGRADE HEROES
    function upgrade(clicked_id) {
        var butIdArray = "but-" + upgradeDict[clicked_id].Row;
        let realScoreCurrent = saveValues["realScore"];
        let costCurrent;
        let currentPurchasedLocal = upgradeDict[clicked_id].Purchased;
        let currentMultiplierLocal = currentMultiplier;
        let requiredFree = 0;

        if (upgradeDict[clicked_id].Purchased === 0) {
            currentMultiplierLocal = 1;
        }
        
        if (currentMultiplierLocal != 1) {
            costCurrent = Math.round(upgradeDict[clicked_id]["BaseCost"] * ((COSTRATIO**currentPurchasedLocal) - COSTRATIO**(currentPurchasedLocal + currentMultiplierLocal)) / (1 - COSTRATIO))
            requiredFree = currentMultiplierLocal;
        } else {
            costCurrent = Math.round(upgradeDict[clicked_id]["BaseCost"] * (COSTRATIO **currentPurchasedLocal));
            requiredFree = 1;
        }

        if (realScoreCurrent >= costCurrent) {
            if (requiredFree) {
                if (saveValues["freeLevels"] > requiredFree) {
                    realScoreCurrent += costCurrent;
                    saveValues["freeLevels"] -= requiredFree;
                }
            }
            
            realScoreCurrent -= costCurrent;
            if (clicked_id === 0) {
                saveValues["clickFactor"] += upgradeDict[clicked_id]["Factor"] * currentMultiplierLocal;
            } else {
                saveValues["dps"] += upgradeDict[clicked_id]["Factor"] * currentMultiplierLocal;
            }

            upgradeDict[clicked_id].Purchased += 1 * currentMultiplierLocal;
            saveValues["heroesPurchased"] += 1 * currentMultiplierLocal;
            checkExpeditionUnlock(saveValues["heroesPurchased"]);                                        
            refresh(butIdArray, upgradeDict[clicked_id]["BaseCost"], clicked_id);
               
            clearTooltip();
            changeTooltip(upgradeDict[clicked_id]["Name"],"hero",clicked_id);                   
            saveValues["realScore"] = realScoreCurrent;
        }
    }

    var currentDimMultiplier = 0;
    var currentMultiplier = 1;
    function costMultiplier(multi) {
        if (currentMultiplier == multi) {
            currentMultiplier = 1;
        } else {
            currentMultiplier = multi;
        }

        let i = WISHHEROMAX;
        while (i--) {
            if (i < WISHHEROMIN && i > NONWISHHEROMAX) continue;
            if (upgradeDict[i]["Purchased"] > 0) {
                let realScoreCurrent = saveValues["realScore"];
                let buttID = "but-" + upgradeDict[i].Row;
                refresh(buttID, upgradeDict[i]["BaseCost"], i);
            }
        } 
    }

    // CHECK IF PRICE IS LOWER THAN CURRENT SCORE
    function dimHeroButton() {
        let i = WISHHEROMAX;
        while (i--) {
            if (i < WISHHEROMIN && i > NONWISHHEROMAX) {
                i -= WISHHEROMIN - NONWISHHEROMAX;
                i += 2;
                continue;
            };
            if (upgradeDict[i]["Purchased"] < 0) continue;

            let checkPrice;
            let upgradeDictTemp = upgradeDict[i];
            if (currentMultiplier > 1 && upgradeDictTemp["Purchased"] > 0) {
                    checkPrice = Math.round(upgradeDictTemp["BaseCost"] * ((COSTRATIO**upgradeDictTemp["Purchased"]) - COSTRATIO**(upgradeDictTemp["Purchased"] + currentMultiplier)) / (1 - COSTRATIO));
                } else {
                    checkPrice = upgradeDictTemp["BaseCost"] * (COSTRATIO ** (upgradeDictTemp["Purchased"]));
                }

            // heroCurrentCosts.set(upgradeDictTemp.Row,checkPrice)

            let heroID = "but-" + upgradeDictTemp.Row;
            let heroElem = document.getElementById(heroID);
            if (checkPrice > saveValues["realScore"]) {
                if (heroElem.classList.contains("dim")) {
                    continue;
                } else {
                    heroElem.classList.add("dim");
                    heroElem.classList.remove("not-dim");
                }
            } else {
                if (heroElem.classList.contains("not-dim")) {
                    continue
                } else {
                    heroElem.classList.add("not-dim");
                    heroElem.classList.remove("dim");
                }
            }
        }
    }

    //------------------------------------------------------------------------TABLE 2 (INVENTORY)------------------------------------------------------------------------//
    // LOAD SAVED INVENTORY
    function inventoryload() {
        for (let i = 1000, len=getHighestKey(Inventory); i < len; i++) {
            if (Inventory[i] == undefined) continue;
            if (Inventory[i].itemCount == 0) continue;
            for (let j = 1, len=Inventory[i].itemCount + 1; j < len; j++) {
                inventoryAdd(i, "load", j);
            }
        }
    }

    // ADD TO INVENTORY 
    function inventoryAdd(idNum, type, count) {
        let itemUniqueID;
        if (type != "load") {
            Inventory[idNum].itemCount++
            itemUniqueID = idNum + "." + Inventory[idNum].itemCount;
        } else {
            itemUniqueID = idNum + "." + count;
        }
        let buttonInv = document.createElement("button");
        buttonInv.classList.add("button-container");
        buttonInv.id = itemUniqueID;
        buttonInv.addEventListener('click', () => {
            itemUse(itemUniqueID);
            Inventory[idNum].itemCount--
        });
        
        buttonInv.addEventListener('mouseover', () => {changeTooltip(Inventory[idNum].Name, "item", Inventory[idNum].Star)})
        buttonInv.addEventListener('mouseout', () => {clearTooltip()})
        buttonInv = inventoryAddButton(buttonInv,Inventory[idNum])
        table2.appendChild(buttonInv);
    }

    // INVENTORY FUNCTIONALITY
    // RMB TO UPDATE CONSTANTS
    const weaponBuffPercent = [0, 1.1, 1.3, 1.7, 2.3, 3];
    const artifactBuffPercent = [0, 1.02, 1.05, 1.10, 1.20, 1.35];
    const foodBuffPercent = [0, 1.2, 1.6, 2.2, 3.0, 4.0];
    function itemUse(itemUniqueId) {
        let item = document.getElementById(itemUniqueId);
        let itemID = itemUniqueId.split(".")[0];
        if (itemID >= 1001 && itemID < WEAPONMAX){
            for (let i = 0, len=WISHHEROMAX; i < len; i++) {
                if (upgradeDict[i] == undefined) continue;
                if (i < WISHHEROMIN && i > NONWISHHEROMAX && i != 1) continue;
                if (upgradeDict[i].Purchased > 0){
                    if (upgradeDict[i].Type == Inventory[itemID].Type){
                        upgradeDict[i]["Factor"] *= weaponBuffPercent[Inventory[itemID].Star];
                        upgradeDict[i]["Factor"] = Math.ceil(upgradeDict[i]["Factor"]);
                        refresh("hero", i);
                    }
                }
            }
        } else if (itemID >= 2001 && itemID < ARTIFACTMAX){
            for (let i = 0, len=WISHHEROMAX; i < len; i++) {
                if (upgradeDict[i] == undefined) continue;
                if (i < WISHHEROMIN && i > NONWISHHEROMAX && i != 1) continue;
                if (upgradeDict[i].Purchased > 0){
                    upgradeDict[i]["Factor"] *= artifactBuffPercent[Inventory[itemID].Star];
                    upgradeDict[i]["Factor"] = Math.ceil(upgradeDict[i]["Factor"]);
                    refresh("hero", i);
                }
            }
        } else if (itemID >= 3001 && itemID <  FOODMAX){
            foodButton(1);
            foodBuff = foodBuffPercent[Inventory[itemID].Star];
        } else if (itemID >= 4001 && itemID <  XPMAX){
            saveValues["freeLevels"] += randomInteger(Inventory[itemID].BuffLvlLow,Inventory[itemID].BuffLvlHigh);
            refresh();
        }
        item.remove();
    }

    // FUNCTIONALITY FOR TEMP FOOD BUFFS (SET TO 30 SECONDS) + RMB TO CHANGE ANIMATION TIME TOO
    function foodCheck(timerSecondsTemp) {
        if (timerSecondsTemp - timeSnapshot1 >= 30) {
            document.getElementById("app"+1).innerHTML = ''
            foodBuff = 1;
        }
        if (timerSecondsTemp - timeSnapshot2 >= 30) {
            document.getElementById("app"+2).innerHTML = ''
        }
    }
    
    function foodButton(type) {
        let container = document.getElementById("app"+type);
        if (type == 1) {
            timeSnapshot1 = timerSeconds;
            container.innerHTML = '';
            container.appendChild(countdownText(1));
        } else {
            timeSnapshot2 = timerSeconds;
            container.innerHTML = '';
            container.appendChild(countdownText(2));
        }
        
    }
    
    //-------------------------------------------------------------TABLE 3 (EXPEDITION + EXPEDITION TOOLTIPS)----------------------------------------------------------//
    // EXPEDITION MECHANICS
    const ADVENTURECOSTS = [0, 100, 250, 500, 750, 1000];
    function adventure(type) {
        if (expeditionDict[type].Locked == '1'){
            alert("ITS LOCKED CANT YOU SEE!!!!!!!")
            return;                                //// <------------------------ ADD THE POPUP FOR LOCKED
        } else {                                                     
            if (saveValues["energy"] >= ADVENTURECOSTS[type]){
                saveValues["energy"] -= ADVENTURECOSTS[type];
                refresh();
                
                switch (type) {
                    case 1:
                        inventoryDraw("artifact", 1, 4);
                        inventoryDraw("weapon", 1, 1);
                        inventoryDraw("xp", 2, 2);
                        inventoryDraw("food", 1, 3);
                        break;
                    case 2:
                        inventoryDraw("xp", 2, 2);
                        inventoryDraw("xp", 2, 2);
                        inventoryDraw("xp", 2, 2);
                        inventoryDraw("food", 2, 3);
                        inventoryDraw("artifact", 2, 4);
                        inventoryDraw("weapon", 1, 2);
                        break;
                    case 3:
                        inventoryDraw("xp", 3, 3);
                        inventoryDraw("xp", 2, 2);
                        inventoryDraw("artifact", 3, 4);
                        inventoryDraw("food", 2, 4);
                        inventoryDraw("weapon", 2, 3);
                        break;
                    case 4:
                        inventoryDraw("xp", 3, 3);
                        inventoryDraw("xp", 3, 3);
                        inventoryDraw("weapon", 3, 4);
                        inventoryDraw("artifact", 3, 4);
                        inventoryDraw("food", 2, 4);
                        break;
                    case 5:
                        inventoryDraw("xp", 3, 3);
                        inventoryDraw("xp", 4, 4);
                        inventoryDraw("artifact", 4, 5);
                        inventoryDraw("weapon", 4, 5);
                        inventoryDraw("food", 2, 5);
                        break;
                    default:
                        break;
                }
                sortList("table2");
                newPop(1);
            }  
        }   
    }

    // DRAWS FOR RANDOM INVENTORY LOOT 
    function inventoryDraw(itemType, min, max){
        let upperInventoryType = {"weapon": WEAPONMAX, "artifact": ARTIFACTMAX, "food": FOODMAX, "xp": XPMAX};
        let lowerInventoryType = {"weapon": 1001, "artifact": 2001, "food": 3001, "xp": 4001};
        let drawnItem = 0;
        while (true){
            drawnItem = randomInteger(lowerInventoryType[itemType], upperInventoryType[itemType])
            if (Inventory[drawnItem] == undefined) {continue}
            if (Inventory[drawnItem].Star >= min && Inventory[drawnItem].Star < (max + 1)) {
                inventoryAdd(drawnItem);
                break;
            } else {
                continue;
            }
        }
    }
    
    // CREATING EXPEDITION UI
    function createExpedition() {
        for (let i = 1; i < 6; i++) {
            let expedButton = document.createElement("button");
            
            if (expeditionDict[i]["Locked"] == 1){
                var backgroundImg = "url(./assets/expedbg/exped6.png)";
            } else {
                var backgroundImg = "url(./assets/expedbg/exped" + i + ".png)";
            }

            expedButton = expedButtonAdjust(expedButton, backgroundImg, i)
            expedButton.addEventListener("click", () => {adventure(i)});
            expedButton.addEventListener("mouseover", function() {expedInfo(this.id)});
            expedButton.addEventListener("mouseout", () => {expedInfo(7)});
            expedDiv.appendChild(expedButton);
        }
    }

    function expedInfo(butId) {
        let expedTableTemp = document.getElementById("expedTableID");
        let expedRow1 = document.getElementById("exped-row-1");
        let expedRow2 = document.getElementById("exped-row-2");
        let i = 0;

        let afterEnergyIcon = document.createElement("img");
        afterEnergyIcon.classList += "after-icon";
        afterEnergyIcon.id = "afterEnergyIcon"
        
        if (butId == 7) {
            i = 7;
        } else {
            i = butId.split("-")[1];
        }

        if (expeditionDict[i]["Locked"] == 0 || i == 7) {
            expedRow1.innerText = expeditionDict[i]["Text"];
            expedRow2.innerText = expeditionDict[i]["Lore"];
            expedRow1.appendChild(afterEnergyIcon);
        } else {
            expedRow1.innerText = expeditionDict[6]["Text"];
            expedRow2.innerText = expeditionDict[6]["Lore"];
        }

        if (i == 7) {
            let afterEnergyRemove = document.getElementById("afterEnergyIcon");
            afterEnergyRemove.remove();
        }
    }

    //------------------------------------------------------------------------TABLE 4 (WISH)------------------------------------------------------------------------//
     // UNLOCK WISH SYSTEM
     function wishUnlock() {
        let wishButtonText = document.getElementById("wishButtonText");
        let wishButton = document.getElementById("wishButton");
        let wishButtonPrimo = document.createElement("img");
        wishButtonPrimo.classList.add("wish-button-primo");
        wishButtonPrimo.src = "./assets/icon/primogemIcon.png";
        
        wishButtonText.innerText = "Write for help | 160 ";
        wishButtonText.append(wishButtonPrimo);
        wishButton.addEventListener("click",() => {
            wish();
        })
    }
    
    // DRAWS/WISH FOR SPECIAL HEROS
    function drawWish() {
        var wishButton = document.createElement("div");
        wishButton.classList += "wish-button";
        wishButton.id = "wishButton"
        let wishButtonText = document.createElement("div");
        wishButtonText.id = "wishButtonText";
        wishButtonText.classList += "wish-button-text";
        wishButtonText.innerText = "???";

        table4 = drawMailTable(table4);

        let mailImageDiv = document.getElementById("mail-image-div");
        let wishButtonImg = document.createElement("img");
        wishButtonImg.src = "./assets/wishButton.webp";
        wishButtonImg.classList += "wish-button-img";
        wishButton.append(wishButtonImg,wishButtonText)
        mailImageDiv.append(wishButton);

        if (wishCounter === saveValues["wishCounterSaved"]) {
            stopWish();
        } else if (saveValues["wishUnlocked"] == true) {
            wishUnlock();
        } 
    }

    function stopWish() {
        let wishButton = document.getElementById("wishButton");
        let wishButtonText = document.getElementById("wishButtonText");
        wishButtonText.innerHTML = "Closed";

        var new_wishButton = wishButton.cloneNode(true);
        wishButton.parentNode.replaceChild(new_wishButton, wishButton);
        let mailImageTemp = document.getElementById("mailImageID");
        mailImageTemp.remove();
    }

    function wish() {
        if (wishCounter === saveValues["wishCounterSaved"]) {
            stopWish();
            return;
        }

        if (saveValues["primogem"] >= WISHCOST) {
            mailElement.load();
            mailElement.play();
            saveValues["primogem"] -= WISHCOST;

            // SCARAMOUCHE WILL ALWAYS BE THE FIRST WISH HERO
            while (wishCounter) {
                let randomWishHero;
                if (upgradeDict[100].Purchased === -10) {
                    randomWishHero = 100;
                    unlockExpedition(5,expeditionDict);
                    newPop(2);
                } else {
                    randomWishHero = randomInteger(WISHHEROMIN, WISHHEROMAX);
                }
            
                if (upgradeDict[randomWishHero].Purchased >= -1) {
                    continue;
                } else {
                    upgradeDict[randomWishHero].Purchased = -1;
                    upgradeDict[randomWishHero]["Factor"] = Math.round(saveValues["dps"] * (STARTINGWISHFACTOR + wishMultiplier)/50 + 1);
                    upgradeDict[randomWishHero]["BaseCost"] = Math.round(saveValues["dps"] * (55) + 1);
                    
                    wishMultiplier += 1.5;
                    saveValues["wishCounterSaved"]++;
                    refresh();
                    newPop(0);

                    let mailImageTemp = document.getElementById("mailImageID");
                    mailImageTemp.style.opacity = 0;
                    break;
                }
            }
        }
    }

    //------------------------------------------------------------------------TABLE 5 (ACHIEVEMENTS)------------------------------------------------------------------------//
    // ACHIEVEMENTS
    var achievementData = {
        achievementTypeRawScore: [10,1e3,1e4,1e6,1e8,1e9,1e11,1e12,1e14,1e15,1e17,1e18,1e20,1e21,1e23,1e24],
        achievementTypeRawDPS:   [1,10,100,10000,1e5,1e6,1e8,1e9,1e11,1e12,1e14,1e15,1e17,1e18,1e20,1e21],
        achievementTypeRawClick: [1e1,1e2,1e3,1e4,1e5],
        achievementTypeRawCollection: [1,10,100,250,500,1000,2500,5000,7500,10000],
    };

    function achievementListload() {
        for (let i = 1, len=getHighestKey(achievementList); i < len; i++) {
            if (achievementList[i] == undefined) continue;
            if (achievementList[i]["Done"] == true) {
                let achievementStored = storeAchievement(achievementList[i].Name,achievementList[i].Description,10000 + i);
                table5.appendChild(achievementStored); 
                sortList("table5");
            }
        }
    }

    var scoreAchievement = [1,101,201,301];
    function popAchievement(achievement) {
        var oldAchievement = document.getElementById("tempAchievement");
        var achievementID = 10000;
        let achievementType = "";

        if (oldAchievement != null) {
            leftDiv.removeChild(oldAchievement); 
        }

        switch (achievement) {
            case "score":
                achievementType = scoreAchievement[0];
                scoreAchievement[0]++;
                break;
            case "dps":
                achievementType = scoreAchievement[1];
                scoreAchievement[1]++;
                break;
            case "click":
                achievementType = scoreAchievement[2];
                scoreAchievement[2]++;
                break;
            case "collection":
                achievementType = scoreAchievement[3];
                scoreAchievement[3]++;
                break;
            default:
                console.log("No more Achievements left!");
                return;
        }

        let achievementListTemp = achievementList[achievementType];
        if (achievementListTemp["Done"] == true) {
            return;
        }

        var achievementText = achievementListTemp.Name;
        var achievementDesc = achievementListTemp.Description;
        achievementList[achievementType]["Done"] = true;
        achievementID += achievementType;
        saveValues["primogem"] += 20;

        if (timerSeconds !== 0) {
            var achievementPopUp = createAchievement(achievementText,achievementDesc);
            achievementPopUp.addEventListener("click", () => {achievementPopUp.remove()});
            achievementPopUp.addEventListener('animationend', () => {achievementPopUp.remove()});
            leftDiv.appendChild(achievementPopUp);
            achievementElement.load();
            achievementElement.play();
        }
        

        //  ^^^ TEMP ACHIEVEMENT | PERMANENT ACHIEVEMENT vvv
        
        let achievementStored = storeAchievement(achievementText,achievementDesc,achievementID);
        table5.appendChild(achievementStored); 
        sortList("table5");
    }

    function checkAchievement() {
        let saveValuesLocal = saveValues;
        if (achievementData["achievementTypeRawScore"].length !== 0){
            if (saveValuesLocal["realScore"] >= achievementData["achievementTypeRawScore"][0]) {
                popAchievement("score");
                achievementData["achievementTypeRawScore"].shift();

                return;
            }
        } 

        if (achievementData["achievementTypeRawClick"].length !== 0){
            if (saveValuesLocal["clickCount"] >= achievementData["achievementTypeRawClick"][0]) {
                popAchievement("click");
                achievementData["achievementTypeRawClick"].shift();
                return;
            }
        }
        
        if (achievementData["achievementTypeRawDPS"].length !== 0){
            if (saveValuesLocal["dps"] >= achievementData["achievementTypeRawDPS"][0]) {
                popAchievement("dps");
                achievementData["achievementTypeRawDPS"].shift();
                return;
            }
        }

        if (achievementData["achievementTypeRawCollection"].length !== 0) {
            if (saveValuesLocal["heroesPurchased"] >= achievementData["achievementTypeRawCollection"][0]) {
                popAchievement("collection");
                achievementData["achievementTypeRawCollection"].shift();
                return;
            }
        }
    }

    //-----------------------------------------------------------------TABLE 6 (TOOLTIPS FOR TABLE 1 & 2)-----------------------------------------------------------//
    // TOOLTIP UI
    var tooltipName = document.createElement("div");
    tooltipName.classList += "tool-tip-name";

    var toolImgContainer = document.createElement("div");
    toolImgContainer.classList.add("toolImgContainer")
    var toolImg = document.createElement("img");
    toolImg.src = "./assets/tooltips/Empty.webp";
    toolImg.classList.add("toolImg");
    var toolImgOverlay = document.createElement("img");
    toolImgOverlay.src = "./assets/tooltips/Empty.webp";
    toolImgOverlay.classList.add("toolImgOverlay");
    toolImgContainer.append(toolImg,toolImgOverlay)
    
    var tooltipText = document.createElement("div");
    tooltipText.classList += "tool-tip-text";
    var tooltipLore = document.createElement("div");
    tooltipLore.classList += "tool-tip-lore";

    let tooltipExtraImg = document.createElement("div");
    tooltipExtraImg.classList += "tool-tip-extraimg";
    var tooltipWeaponImg = document.createElement("img");
    var tooltipElementImg = document.createElement("img");
    
    tooltipExtraImg.append(tooltipWeaponImg,tooltipElementImg)

    var table6Background = document.createElement("img");
    table6Background.src = "./assets/tooltips/background.webp"
    table6Background.classList.add("table6-background");
    table6.append(tooltipName,toolImgContainer,tooltipText,tooltipExtraImg,tooltipLore,table6Background);

    function changeTooltip(name, type, ID) {
        tooltipName.innerText = tooltip[name]["name"];
        tooltipLore.innerText = tooltip[name]["lore"];

        if (type == "hero") {
            let upgradeDictLocal = upgradeDict;
            let tooltipTextLocal = "Times upgraded: " +upgradeDictLocal[ID]["Purchased"]+ "<br />Free Levels: " +saveValues["freeLevels"];
            toolImgOverlay.src = "./assets/tooltips/hero/"+name+".webp";
            tooltipElementImg.src = "./assets/tooltips/elements/" +upgradeDictLocal[ID].Ele+ ".webp";
            tooltipWeaponImg.src = "./assets/tooltips/elements/" +upgradeDictLocal[ID].Type+ ".webp";
            
            tooltipText.innerHTML = tooltipTextLocal;
        } else if (type == "item") {
            toolImg.src = "./assets/frames/background-" + ID + ".webp";
            toolImgOverlay.src = "./assets/tooltips/inventory/" + name + ".webp";
            return;
        }
    }

    function clearTooltip() {
        tooltipName.innerText = "";
        tooltipText.innerText = "";
        tooltipLore.innerText = "";
        tooltipWeaponImg.src = "./assets/tooltips/Empty.webp";
        tooltipElementImg.src = "./assets/tooltips/Empty.webp";
        toolImg.src = "./assets/tooltips/Empty.webp";
        toolImgOverlay.src = "./assets/tooltips/Empty.webp";
    }

    //------------------------------------------------------------------------MISCELLANEOUS------------------------------------------------------------------------//
    // REFRESH SCORES & ENERGY
    function refresh() {
        let formatScore = abbrNum(saveValues["realScore"]);
        score.innerText = `${formatScore} Nut${saveValues["realScore"] !== 1 ? 's' : ''}`;
        
        let formatDps = abbrNum(saveValues["dps"] * foodBuff);
        dpsDisplay.innerText = formatDps + " per second" ;
        energyDisplay.innerText = saveValues["energy"];
        primogemDisplay.innerText = saveValues["primogem"];
        
        if (arguments[0] != undefined) { // BUYING A HERO / UPDATING MULTIPLIERS
            if (arguments[0].includes("but-")){
                let heroTextFirst = "";
                let formatCost = arguments[1];
                let upgradeDictTemp = upgradeDict[arguments[2]];
                let currentPurchased = upgradeDictTemp["Purchased"];
                let formatATK = upgradeDictTemp["Factor"];

                if (currentMultiplier != 1) {
                    formatCost *= (((COSTRATIO**currentPurchased) - COSTRATIO**(currentPurchased + currentMultiplier)) / (1 - COSTRATIO));
                    formatATK *= currentMultiplier;
                } else {
                    formatCost *= (COSTRATIO**currentPurchased);
                }

                formatCost = abbrNum(formatCost);

                if (arguments[2] == 0) {
                    let singular = ` Nut${formatATK !== 1 ? 's' : ''} per click`;
                    formatATK = abbrNum(formatATK)
                    heroTextFirst = upgradeDictTemp.Name + ": " + formatCost + ", +" + formatATK + singular;
                } else {
                    formatATK = abbrNum(formatATK)
                    heroTextFirst = upgradeDictTemp.Name + ": " + formatCost + ", +" + formatATK + " NpS";
                }
                
                let upgradedHeroButton = document.getElementById(arguments[0]);
                upgradedHeroButton.innerText = heroTextFirst;
                upgradedHeroButton.style = "background:url(./assets/nameplates/"+upgradeDictTemp.Name.replace(/ /g,'')+".webp);  background-size: 125%; background-position: 99% center; background-repeat: no-repeat;";
            }
            else if (arguments[0] == "hero") { // REFRESH FOR ARTIFACTS
                let hero = upgradeDict[arguments[1]];
                let formatATK = hero["Factor"];
                let formatCost = hero["BaseCost"];
                let currentPurchased = hero["Purchased"];

                if (currentMultiplier != 1) {
                    formatCost *= (((COSTRATIO**currentPurchased) - COSTRATIO**(currentPurchased + currentMultiplier)) / (1 - COSTRATIO));
                    formatATK *= currentMultiplier;
                } else {
                    formatCost *= (COSTRATIO**currentPurchased);
                }

                let heroText = hero.Name + ": " + abbrNum(formatCost) + ", +" + abbrNum(formatATK) + " NpS";
                let id="but-" + hero.Row + "";
                document.getElementById(id).innerText = heroText;
            }
        }
    }

    // POP UPS FOR EXPEDITIONS UNLOCKS
    // NUMBER OF UPGRADES NEEDED TO UNLOCK EXPEDITIONS vvvv
    var heroUnlockLevels = [150,300,450];
    var expeditionCounter = 0;
    function checkExpeditionUnlock(heroesPurchasedNumber) {
        if (heroUnlockLevels.length == 0) {
            return;
        } else if (heroesPurchasedNumber >= heroUnlockLevels[0]) {
            if (expeditionDict[expeditionCounter + 3].Locked == 1) {
                if (heroUnlockLevels.length != 1) {
                    unlockExpedition(expeditionCounter + 3,expeditionDict);
                    newPop(2);
                } else {
                    if (saveValues["wishUnlocked"] === true) {
                        return;
                    } else {
                        newPop(3);
                        wishUnlock();
                        saveValues["wishUnlocked"] = true;
                    }
                }
                newPop(expeditionCounter + 4);
            }
            expeditionCounter++;
            heroUnlockLevels.shift()
        }
    }
    
    // POP UPS FOR NEW HEROES(WISH), INVENTORY AND EXPEDITION
    var currentPopUps = [];
    function newPop(type) {
        var newPopUp;
        let className;
        let tabId;
        let place;

        if (type <=3 && type >=0) {
            if (newPopUp || currentPopUps.includes(type) == true) {
                return;
            }
            className = "pop-new-" + (type + 1);
            tabId = "tab-" +  (type).toString();
            place = "tab";
        } else if (type <=6 && type >=4) {
            className = "pop-new-corner";
            place = "corner";
        } else {
            return;
        }
        
        newPopUp = document.createElement("div");
        if (place == "tab") {
            currentPopUps.push(type);
            newPopUp.classList.add("pop-new", className);
            let tab = document.getElementById(tabId);
            
            tab.addEventListener("click", () => {
                if (newPopUp != null) {
                    newPopUp.remove();
                    currentPopUps.splice(currentPopUps.indexOf(type),1);
                    newPopUp = null;
                }
            });
            tab.appendChild(newPopUp);
        } else if (place == "corner"){
            newPopUp.classList.add(className);
            let newPopUpImg = document.createElement("img");
            type--;
            newPopUpImg.src = "./assets/tutorial/unlockExp-"+type+".webp"
            newPopUp.appendChild(newPopUpImg)

            
            setTimeout(() => {
                newPopUp.addEventListener("click", () => {
                    if (newPopUp != null) {
                        newPopUp.remove();
                    }
                });
            }, 2000)

            setTimeout(() => newPopUp.remove(), 13000)
            let mainBody = document.getElementById("game");    
            mainBody.append(newPopUp);
        }    
    }

</script>
</body>
</html>
